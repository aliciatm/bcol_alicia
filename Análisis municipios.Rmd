---
title: "Análisis municipios"
output: html_document
date: "2024-04-15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Paquetes

```{r}
library(tidyverse)
library(readxl)
library(haven)
library(mice)
library(factoextra)
library(ggpubr)

```


## Importar base de datos

```{r}

municipios <- read_xlsx("municipios.xlsx")

propiedad <- read_xlsx("propiedad.xlsx")

```

## Descriptivo de lss variables de municipios
### IPV
Panorama general: en los ultimos años ha aumentado tal, viviendas vacias por ejemplo, tal nivel de turisticas. Esto lleva a un regimen de tenencia que tal. Pero es asi en todos?

- IPV. El IPV es un índice que mide la evolución de precios de las viviendas partiendo de una base 100 establecida por el precio en 2015. La media del IPV General, resultado del precio de todas las viviendas en el mercado es de 125, lo que indica un aumento del precio del 25% desde 2015. 

En los boxplot observamos que el IPV General tiene varios outliers con un valor mucho más alto que la media. Vemos también  que esto se repite en los casos de IPV de vivienda de Segunda mano y de vivienda Nueva. El IPV general tiene un valor mucho más cercano al de IPV Segunda, lo que nos indica que en el mercado hay más compraventa de viviendas de segunda mano que de nueva construcción.

Las CCAA donde ha aumentado más el precio de la vivienda son Madrid, Illes Balears, Barcelona, Ceuta y Melilla.

```{r}

# IPV
mean(municipios$ipv2021General)
mean(municipios$ipv2011General)

ggplot(municipios, aes(x = 1, y = ipv2021General, fill = "ipv2021General")) +
  geom_boxplot(position = position_dodge(width = 0.8), fill = "Orange") +
  geom_boxplot(aes(x = 2, y = ipv2021Nueva, fill = "ipv2021Nueva"), position = position_dodge(width = 0.8), fill = "Blue") +
  geom_boxplot(aes(x = 3, y = ipv2021Segunda, fill = "ipv2021Segunda"), position = position_dodge(width = 0.8), fill = "Green") +
  scale_x_continuous(breaks = c(1, 2, 3), labels = c("ipv2021General", "ipv2021Nueva", "ipv2021Segunda")) +
  labs(y = "Índice de Precio de Viviendas",
       title = "Distribución del Índice de Precio de Viviendas por Tipo en 2021") +
  theme_minimal()

# top ipv 2021
municipios |> 
  distinct(CCAA, .keep_all = T) |> 
  arrange(desc(ipv2021General)) |> 
  slice(1:5)




# Edad
mean(compra21_r$VAREDAD)
round(prop.table(table(compra21_r$VAREDAD)), digits = 3)
hist(compra21_r$VAREDAD)

# Número de orden
round(prop.table(table(compra21_r$NORDEN)), digits = 3)
(table(compra21_r$NORDEN))

bxp<-ggplot(data,mapping=aes(x=Priorprograms))+geom_histogram(bins=15,fill="Orange",aes(y=..count../sum(..count..)))

ggarrange(bxp,dp,db,ds,
          ncol = 2, nrow = 2)



```

### RentaMedia2021

Renta media disponible/neta personal. El valor medio de los municipios es 21236€ anuales. Sin embargo hay mucha variación entre municipios. El municipio con más renta es Pozuelo de Alarcón con un valor de 57977€, mientras el de renta más baja es Tudela en Navarra con 13443€.

```{r}
mean(municipios$RentaMedia2021)

municipios |> 
  arrange(desc(RentaMedia2021)) |> 
  slice(1:3) |> 
  select(PROV_LITERAL, MUN_LITERAL, RentaMedia2021)

municipios |> 
  arrange(RentaMedia2021) |> 
  slice(1:3) |> 
  select(PROV_LITERAL, MUN_LITERAL, RentaMedia2021)


```

### PorcentajeJoven

La media del porcentaje de población joven en los municipios en 2021 es de 36%, mientras que en 2011 era 39%. Ha descendido la cantidad de jóvenes.

Los municipios donde hay más población joven son Vícar en Almería probablemente por la alta presencia de temporeros jóvenes, 

```{r}

mean(municipios$PorcentajeJoven2021)
mean(municipios$PorcentajeJoven2011)

municipios |> 
  arrange(desc(PorcentajeJoven2021)) |> 
  slice(1:3) |> 
  select(PROV_LITERAL, MUN_LITERAL, PorcentajeJoven2021)

municipios |> 
  arrange(PorcentajeJoven2021) |> 
  slice(1:3) |> 
  select(PROV_LITERAL, MUN_LITERAL, PorcentajeJoven2021)



```


# Descriptivo: en qué municios/provincia entonces ha aumentado la compra

No, no es en todos. En estos municipios pasa tal. Hacer análisis por provincias y revisar los casos estos donde top herencia = top diferencia. Porque por ejemplo en Jaén 2000 no era por herencia, sino por temas de cesión.

### Mapa Provincias
### En 2011

```{r, fig.height=6, fig.width=12}

library(mapSpain)
  
esp_can <- esp_get_country() 
can_prov <- esp_get_can_provinces()
can_box <- esp_get_can_box() 
munic <- esp_get_munic() 

provic <- esp_get_prov() |> 
  mutate(CPRO = cpro)

mapa <- propiedad |> 
  select(CPRO, Propiedad11Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

# Propiedad
p1 <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Propiedad11Prov), color = "black", size = 1) + 
        geom_sf_text(data = mapa, aes(label = round(Propiedad11Prov, 1)), color = "black", size = 2.5, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas
  theme_void() +  
  labs(title = "Porcentaje de propiedad por provincia 2011") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1)

# Herencia o donación

mapa <- propiedad |> 
  select(CPRO, Herencia11Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p2 <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Herencia11Prov), color = "black", size = 1) + 
        geom_sf_text(data = mapa, aes(label = round(Herencia11Prov, 1)), color = "black", size = 2.5, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas
  theme_void() +  
  labs(title = "Porcentaje de herencia/donación por provincia 2011") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1)

# Alquiler
mapa <- propiedad |> 
  select(CPRO, Alquiler11Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p3 <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Alquiler11Prov), color = "black", size = 1) + 
        geom_sf_text(data = mapa, aes(label = round(Alquiler11Prov, 1)), color = "black", size = 2.5, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas
  theme_void() +  
  labs(title = "Porcentaje de alquiler por provincia 2011") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1)

# Otro
mapa <- propiedad |> 
  select(CPRO, Otro11Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p4 <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Otro11Prov), color = "black", size = 1) + 
        geom_sf_text(data = mapa, aes(label = round(Otro11Prov, 1)), color = "black", size = 2.5, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas
  theme_void() +  
  labs(title = "Porcentaje de otro por provincia 2011") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1)


ggarrange(p1, p2, p3, p4, ncol=2, nrow = 2)

```

### En 2021

```{r, fig.height=6, fig.width=12}

library(mapSpain)
  
esp_can <- esp_get_country() 
can_prov <- esp_get_can_provinces()
can_box <- esp_get_can_box() 
munic <- esp_get_munic() 
  
ccaa <- esp_get_ccaa() |> 
  mutate(codauto = codauto)

mapa <- propiedad |> 
  select(CPRO, Propiedad21Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

# Propiedad
p1 <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Propiedad21Prov), color = "black", size = 1) + 
        geom_sf_text(data = mapa, aes(label = round(Propiedad21Prov, 1)), color = "black", size = 2.5, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas
  theme_void() +  
  labs(title = "Porcentaje de propiedad por provincia 2021") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1)

# Alquiler
mapa <- propiedad |> 
  select(CPRO, Alquiler21Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p2 <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Alquiler21Prov), color = "black", size = 1) + 
        geom_sf_text(data = mapa, aes(label = round(Alquiler21Prov, 1)), color = "black", size = 2.5, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas
  theme_void() +  
  labs(title = "Porcentaje de alquiler por provincia 2021") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1)

# Otro
mapa <- propiedad |> 
  select(CPRO, Otro21Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p3 <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Otro21Prov), color = "black", size = 1) + 
        geom_sf_text(data = mapa, aes(label = round(Otro21Prov, 1)), color = "black", size = 2.5, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas
  theme_void() +  
  labs(title = "Porcentaje de otro por provincia 2021") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1)


ggarrange(p1, p2, p3, ncol=2, nrow = 2)


```


# Regímenes de tenencia
### 2011

### Por municipios

```{r}
# Propiedad

# Compra
top_compra_2011 <- compra11 %>%
  arrange(desc(Compra11Mun)) %>%
  distinct(Compra11Mun, .keep_all = TRUE) |> 
  select(Compra11Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

# Herencia
top_herencia_2011 <- compra11 %>%
  arrange(desc(Herencia11Mun)) %>%
  distinct(cusec, .keep_all = TRUE) |> 
  select(Herencia11Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

# Alquiler
top_alquiler_2011 <- compra11 %>%
  arrange(desc(Alquiler11Mun)) %>%
  distinct(cusec, .keep_all = TRUE) |> 
  select(Alquiler11Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

# Otro
top_otro_2011 <- compra11 %>%
  arrange(desc(Otro11Mun)) %>%
  distinct(cusec, .keep_all = TRUE) |> 
  select(Otro11Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

top_compra_2011
top_herencia_2011
top_alquiler_2011
top_otro_2011

```

En 2021

```{r}
# Propiedad
top_propiedad_2021 <- compra21 |> 
    distinct(cusec, .keep_all = TRUE) |> 
    arrange(desc(Propiedad21Mun)) |> 
    select(Propiedad21Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

# Alquiler
top_alquiler_2021 <- compra21 |> 
    distinct(cusec, .keep_all = TRUE) |> 
    arrange(desc(Alquiler21Mun)) |> 
    select(Alquiler21Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

# Otro
top_otro_2021 <- compra21 |> 
    distinct(cusec, .keep_all = TRUE) |> 
    arrange(desc(Otro21Mun)) |> 
    select(Propiedad21Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

top_propiedad_2021
top_alquiler_2021
top_otro_2021

```


### Por provincias

```{r}
# Compra
top_compra_2011 <- compra11 |> 
    distinct(CPRO, .keep_all = TRUE) |> 
    arrange(desc(Compra11Prov)) |> 
    select(Compra11Prov, PROV_LITERAL, CCAA)

# Herencia
top_herencia_2011 <- compra11 |> 
    distinct(CPRO, .keep_all = TRUE) |> 
    arrange(desc(Herencia11Prov)) |> 
    select(Herencia11Prov, PROV_LITERAL, CCAA)

# Alquiler
top_alquiler_2011 <- compra11 %>%
  arrange(desc(Alquiler11Prov)) %>%
  distinct(CPRO, .keep_all = TRUE) |> 
  select(Alquiler11Prov, PROV_LITERAL, CCAA)

# Otro
top_otro_2011 <- compra11 %>%
  arrange(desc(Otro11Prov)) %>%
  distinct(CPRO, .keep_all = TRUE) |> 
  select(Otro11Prov, PROV_LITERAL, CCAA)

top_compra_2011
top_herencia_2011
top_alquiler_2011
top_otro_2011


```

### 2021

```{r}

# Propiedad
top_propiedad_2021 <- compra21 |> 
    distinct(CPRO, .keep_all = TRUE) |> 
    arrange(desc(Propiedad21Prov)) |> 
    select(Propiedad21Prov, PROV_LITERAL, CCAA)

# Alquiler
top_alquiler_2021 <- compra21 |> 
    distinct(CPRO, .keep_all = TRUE) |> 
    arrange(desc(Alquiler21Prov)) |> 
    select(Alquiler21Prov, PROV_LITERAL, CCAA)

# Otro
top_otro_2021 <- compra21 |> 
    distinct(CPRO, .keep_all = TRUE) |> 
    arrange(desc(Otro21Prov)) |> 
    select(Propiedad21Mun, PROV_LITERAL, CCAA)

top_propiedad_2021
top_alquiler_2021
top_otro_2021
```

# Diferencia entre años

### Municipios

```{r}

# Propiedad
dif_propiedad_mun <- propiedad |> 
    distinct(PropiedadDifMun, .keep_all = TRUE) |> 
  arrange(desc(PropiedadDifMun)) |> 
    select(PropiedadDifMun, MUN_LITERAL, PROV_LITERAL, CCAA)

# Alquiler

dif_alquiler_mun <- propiedad %>%
    distinct(AlquilerDifMun, .keep_all = TRUE) |> 
  arrange(desc(AlquilerDifMun)) %>%
    select(AlquilerDifMun, MUN_LITERAL, PROV_LITERAL, CCAA)

# Otro

dif_otro_mun <- propiedad %>%
    distinct(OtroDifMun, .keep_all = TRUE) |> 
  arrange(desc(OtroDifMun)) %>%
    select(OtroDifMun, MUN_LITERAL, PROV_LITERAL, CCAA)
```

### Provincias

```{r}

# Propiedad
dif_propiedad_prov <- propiedad |> 
    distinct(PropiedadDifProv, .keep_all = TRUE) |> 
  arrange(desc(PropiedadDifProv)) |> 
    select(PropiedadDifProv, PROV_LITERAL, CCAA)

# Alquiler

dif_alquiler_prov <- propiedad %>%
    distinct(AlquilerDifProv, .keep_all = TRUE) |> 
  arrange(desc(AlquilerDifProv)) %>%
    select(AlquilerDifProv, PROV_LITERAL, CCAA)

# Otro

dif_otro_prov <- propiedad %>%
    distinct(OtroDifProv, .keep_all = TRUE) |> 
  arrange(desc(OtroDifProv)) %>%
    select(OtroDifProv, PROV_LITERAL, CCAA)

```

### CCAA

```{r}
# Propiedad
dif_propiedad_ccaa <- propiedad |> 
    distinct(PropiedadDifCCAA, .keep_all = TRUE) |> 
  arrange(desc(PropiedadDifCCAA)) |> 
    select(PropiedadDifCCAA, PROV_LITERAL, CCAA)

# Alquiler

dif_alquiler_prov <- propiedad %>%
    distinct(AlquilerDifProv, .keep_all = TRUE) |> 
  arrange(desc(AlquilerDifProv)) %>%
    select(AlquilerDifProv, PROV_LITERAL, CCAA)

# Otro

dif_otro_prov <- propiedad %>%
    distinct(OtroDifProv, .keep_all = TRUE) |> 
  arrange(desc(OtroDifProv)) %>%
    select(OtroDifProv, PROV_LITERAL, CCAA)

```

## PCA

Qué tienen estos municipios en común? Qué distingue unos de los otros? Pues vamos a ver los componentes y clusters

Con 10 componentes explicamos el 88.4% de la variabilidad; con 5, el 70%. Dos son 41.2%.

We first create a database keeping only the numeric columns which are going to contribute to our PCA analysis. We observe that with 7 components we explain 100% of variability, and with 2 we explain 65.3% of variability.

COMRPOBAR SI TODO ES NUMERICO   


### Poner provincia en municipios pequeños

```{r}
municipios <- municipios |> 
    mutate(MUN_LITERAL = ifelse(grepl("\\d", MUN_LITERAL), paste(MUN_LITERAL, PROV_LITERAL), MUN_LITERAL))


```

pca

```{r, fig.height=6, fig.width=12}

todopropiedad <- propiedad |> 
  select(cusec, Propiedad21Mun, Alquiler21Mun, Otro21Mun, Propiedad11Mun, Herencia11Mun, Alquiler11Mun, Otro11Mun, PropiedadDifMun, AlquilerDifMun, OtroDifMun)

municipios <- municipios |> 
  select(-Propiedad21Mun, -Alquiler21Mun, -Otro21Mun, -Compra11Mun, -Herencia11Mun, -Alquiler11Mun, -Otro11Mun, -PropiedadDifMun, -AlquilerDifMun) |> 
  left_join(todopropiedad, by = "cusec") 

municipios <- municipios |> 
  select(-OtroDifMun.x) |> 
  mutate(OtroDifMun = OtroDifMun.y)

municipios <- municipios |> 
  select(MUN_LITERAL, PROV_LITERAL, CCAA, PropiedadDifMun, AlquilerDifMun, OtroDifMun, Herencia11Mun, RentaMedia2021, PorcentajeJoven2021, PorcentajeJovenDif, PorcentajeVacias2021, PorcentajeSecundarias2021, PorcentajeEspañola, PorcentajeProtegidas2021, ProtegidaDif,PrecioAlquilerM2)


# Keeping the names of municipalities and CCAA
names = municipios$MUN_LITERAL
prov = municipios$PROV_LITERAL
ccaa = municipios$CCAA

# Creating only numeric database
numeric_data <- municipios %>%
  ungroup() |> 
  select_if(is.numeric) 

# Creating the components
set.seed(123)
pca = prcomp(numeric_data, scale=T)
summary(pca)

# Plot of the variability explained by components
fviz_screeplot(pca, addlabels = TRUE)
```


### Analizar cada componente

*Componente 1*. Las variables que más contribuyen a este componente es PorcentajeVacías2021, PorcentajeSecundarias2021, PrecioAlquilerM2 y PorcentajeProtegidas2021. Son variables relacionadas con el mercado de vivienda en sí de los municipios, no tiene relación cosas como la diferencia en regímenes de tenencia o características de la población juvenil.

- PorcentajeVacías2021. Muy alto porcentaje de viviendas vacías.
- PorcentajeSecundarias2021. Muy alto porcentaje de viviendas secundarias.
- PrecioAlquilerM2. Muy bajo el precio de alquiler.
- PorcentajeProtegidas2021. Muy pocas viviendas protegidas.
- PropiedadDifMun. Aumento significativo de la propiedad en el municipio.
- AlquilerDifMun. Gran descenso del alquiler.
- OtroDifMun. Ligero aumento de 'otro'.
- Herencia11Mun. Bastante herencia de viviendas principales en los municipios.

Los municipios con más puntuación en este componente son municipios muy pequeños de Ourense y Lugo. Son municipios rurales con pocas personas jóvenes residentes, con gran cantidad de viviendas secundarias o vacías, bajo precio... También vemos que tienen más herencia que otros municipios, gran reducción del alquiler y aumento de la propiedad y de 'Otro'.

Por otra parte, los municipios con menor puntuación son municipios con muy pocas viviendas vacías, un alquiler caro, o además con muchas viviendas protegidas como Ceuta. Tampoco han experimentado un aumento de la propiedad significativo.


```{r, fig.height=6, fig.width=12}

# Contribution of variables to component 1
fviz_contrib(pca, choice = "var", axes = 1)

# Plot adjustments
n <- 10
col_pos <- colorRampPalette(c("#CCE6CC", "#208909"))(n)
col_neg <- colorRampPalette(c("#FFE6E6", "#B30000"))(n)
coefs <- pca$rotation[,1]
valor_max <- max(coefs)
valor_min <- min(coefs)
coefs_ajustados <- coefs - valor_min + 1
colores <- ifelse(coefs >= 0, col_pos[ceiling((coefs_ajustados / (valor_max - valor_min + 1)) * n)], 
                  col_neg[ceiling((abs(coefs_ajustados) / (valor_max - valor_min + 1)) * n)])

# Plot
barplot(coefs, las = 2, col = colores, cex.names = 0.8)

#Ranking of municipalities of this component
names[order(pca$x[,1], decreasing=T)][1:5]
names[order(pca$x[,1])][1:5]


```

*Componente 2*. Las variables más relevantes en el componente 2 es PropiedadDifMun, OtroDifMun, ProtegidaDif, PorcentajeProtegidas2021. Básicamente, ahora sí entran en juego los regímenes de tenencia.

- PropiedadDifMun. Ha aumentado muchísimo la propiedad.
- OtroDifMun. Se ha reducido mucho el régimen 'Otro'. 
- ProtegidaDif. Se ha reducido mucho las viviendas protegidas.
- PorcentajeProtegidas2021. La cantidad de viviendas protegidas es alta.
- PorcentajeJovenDif. Un aumento de la cantidad de jóvenes.
- PrecioAlquilerM2. Un precio mediano del alquiler.

Los municipios con mayor puntuación son Ceuta, Zarautz, Pozuelo de Alarcón y Nerja. Estos primeros 3 municipios no tienen un aumento muy significativo de la propiedad, si bien por lo menos no es un descenso. Lo que hace que aparezcan aquí es la cantidad de viviendas protegidas. Este valor es por CCAA, no por municipio. Con lo cual, parece que este componente está agrupando a muchos municipios de la misma CCAA (Madrid, Navarra) sólo por tener ese valor de viviendas protegidas, y porque no tienen un descenso en la propiedad. 

En el caso de Nerja y Jaén, es el caso contrario: aparecen por un gran aumento en la propiedad pero la cantidad de viviendas protegidas es reducida.

```{r, fig.height=6, fig.width=12}

# Contribution of variables to component 1
fviz_contrib(pca, choice = "var", axes = 2)

# Plot adjustments
coefs <- pca$rotation[,2]
valor_max <- max(coefs)
valor_min <- min(coefs)
coefs_ajustados <- coefs - valor_min + 1
colores <- ifelse(coefs >= 0, col_pos[ceiling((coefs_ajustados / (valor_max - valor_min + 1)) * n)], 
                  col_neg[ceiling((abs(coefs_ajustados) / (valor_max - valor_min + 1)) * n)])

# Plot
barplot(coefs, las = 2, col = colores, cex.names = 0.8)

#Ranking of municipalities of this component
names[order(pca$x[,2], decreasing=T)][1:5]
names[order(pca$x[,2])][1:5]

```

### Plot de componentes

Ahora podemos analizar el siguiente gráfico que posiciona los municipios en los ejes según su puntuación en cada uno de los dos primeros componentes. 

P1: Muchas vacías, secundarias, muy pocas protegidas, alquiler bajo, aumento propiedad y mucho descenso alquiler

P2: Mucha vivienda protegida, mucho aumento propiedad

Con respecto al eje X, del PC1, vemos que a la derecha se encuentran municipios con más puntuación. Son municipios con muchas viviendas vacías o secundarias, así como un aumento de la propiedad. Están pequeños pueblos gallegos, de las islas, andaluces, y otras provincias que no son capitales de comunidad. En la izquierda vemos municipios con muy pocas viviendas secundarias/vacías, o sea, pocas viviendas 'que sobren'. Municipios madrileños caros, con renta alta. También País Vasco, Cataluña... Conforme nos acercamos de la izquierda al centro vemos municipios que se van alejando de esta definición, pero siguen siendo ciudades 'relevantes', con bastante ocupación de las viviendas: albacete, Granada, El Ejido. Destaca el caso de Ceuta por su poca cantidad de viviendas vacías y secundarias debido a su poco territorio, así como un precio de alquiler que entraría en el 20% más caro de todos los municipios.

En el eje Y, PC2, se centra más en la presencia de vivienda protegida y aumento de la propiedad. También en aumento de personas jóvenes y precio mediano de alquiler. Ceuta se posiciona en primer lugar por ser el municipio con más cantidad de vivienda protegida. También tiene un aumento en la propiedad (si bien es ligero). Por otra parte, vemos que los municipios se sitúan todos en una posición del eje Y similar, no hay tantas diferencias como en el primer componente. El municipio con menor puntuación es pueblos de menos de 2000-5000 habitantes de Las Palmas, con poca vivienda protegida y un gran descenso de la propiedad.

```{r, fig.height=7, fig.width=14}
p <-data.frame(z1 = pca$x[,1], z2 = pca$x[,2]) %>%
  ggplot(aes(z1, z2, label = names, color = ccaa)) +
  geom_point(size = 0) +
  labs(title = "First two principal components (scores)", x = "PC1", y = "PC2") +  theme_bw() +   theme(legend.position = "bottom") +
  geom_text(size = 3, hjust = 0.6, vjust = 0, check_overlap = T)

p

# Versión interactiva
ggplotly(p)

```

### Aplly clustering tools and interpret

Usando el método wss y silhouette sugiere utilizar 3 clusters. Con gap_stat sugiere 6.

```{r}

#fviz_nbclust(scale(numeric_data), kmeans, method = 'wss', k.max = 20, nstart = 1000)

#fviz_nbclust(scale(numeric_data), kmeans, method = 'silhouette', k.max = 20, nstart = 1000)

#fviz_nbclust(scale(numeric_data), kmeans, method = 'gap_stat', k.max = 10, nstart = 100, nboot = 100)

```

```{r, fig.height=6, fig.width=12}
set.seed(123)
fit <- kmeans(numeric_data, centers=3, nstart = 100)
fit

fviz_cluster(fit, data = numeric_data, geom = c("point"),ellipse.type = 'norm', pointsize=1)+
  theme_minimal()+geom_text(label=names,hjust=0, vjust=0,size=2,check_overlap = T)+scale_fill_brewer(palette="Paired")

```

Realmente los clusters no me están explicando tanto.

## Modelo

Vale, entonces cómo influye cada variable exactamente en el reg de tenencia?

Si quito variables como secundarias, vacias, protegidas... el precio alquiler no toma mas relevancia. Parecen más relevantes esas características del mercado que el precio o características de la población.

```{r}

independientes <- numeric_data |> 
  select(PropiedadDifMun, RentaMedia2021, PorcentajeJoven2021, PorcentajeJovenDif, PorcentajeVacias2021, PorcentajeSecundarias2021, PorcentajeEspañola, PorcentajeProtegidas2021, ProtegidaDif, PrecioAlquilerM2)

modelo <- lm(PropiedadDifMun ~ ., data = independientes)

summary(modelo)


```

### Logit

La accuracy es muy alta pero claro porque las clases están super desequilibradas, entonces con que acierte sólo 7 de los aumentos da un 91%.
```{r}

# Preparar datos
municipios <- read_xlsx("municipios.xlsx")
propiedad <- read_xlsx("propiedad.xlsx")

municipios <- municipios |> 
    mutate(MUN_LITERAL = ifelse(grepl("\\d", MUN_LITERAL), paste(MUN_LITERAL, PROV_LITERAL), MUN_LITERAL))

numeric_data <- numeric_data %>%
  mutate(Propiedad = ifelse(PropiedadDifMun >= 0, 1, 0)) %>%
  select(Propiedad, RentaMedia2021, PorcentajeJoven2021, PorcentajeJovenDif, PorcentajeVacias2021, PorcentajeSecundarias2021, PorcentajeEspañola, PorcentajeProtegidas2021, ProtegidaDif, PrecioAlquilerM2) 
# Modelo
modelo <- glm(Propiedad ~ ., data = numeric_data, family = binomial(link = "logit"))

summary(modelo)

# Matriz de confusión
prob_pred <- predict(modelo, type = "response")
clases_pred <- ifelse(prob_pred > 0.5, 1, 0)

table(Real = numeric_data$Propiedad, Predicho = clases_pred)

# Accuracy
sum(diag(confusion_matrix)) / sum(confusion_matrix)


```


### Modelo precio alquiler

```{r}

# Modelo para explicar precio alquiler con 0.84 R2
modelo <- lm(PrecioAlquilerM2 ~ ., data = numeric_data)

summary(modelo)

```


## Apuntes

Parte del descriptivo de los individuos lo tengo ya hecho

Preparar clusters etc copiandome del trabajo de advanced modelling. También tengo ahí texto que describe la pregunta de investigación, los análisis...

- ¿Tipos de perfil de individuo comprante?

Hacer cluster con solo regimenes de enencia de munis? ver diferencias entre si pierde otro, si pierde alquiler... como he analizao un poco.