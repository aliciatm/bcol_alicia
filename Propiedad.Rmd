---
title: "Propiedad"
output: html_document
date: "2024-05-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Paquetes

```{r}
library(tidyverse)
library(ggpubr)
library(ggplot2)
library(patchwork)
library(readxl)
library(haven)
library(flextable)

library(extrafont)

# Importar fuentes del sistema operativo
#font_import(prompt = FALSE)

# Cargar fuentes
loadfonts(device = "win")

```

# Creando database 'Propiedad'

### Crear cusec y poner nombres

```{r}

# Importar microdatos 2011
microdatos2011 <- read_sav("Microdatos2011/Personas/poblacion_2011_v2.sav")

propiedad <- microdatos2011 |> 
  select(CPRO, CMUN)

# Crear los códigos cusec de los municipios rurales y sus nombres
cusec_991 <- sprintf("%05d", seq(1991, 52991, by = 1000))
cusec_992 <- sprintf("%05d", seq(1992, 52992, by = 1000))
cusec_993 <- sprintf("%05d", seq(1993, 52993, by = 1000))
cusec_994 <- sprintf("%05d", seq(1994, 52994, by = 1000))
cusec <- c(cusec_991, cusec_992, cusec_993, cusec_994)

MUN_LITERAL <- 
  ifelse(substr(cusec, 4, 5) == "91","<=2000",
  ifelse(substr(cusec, 4, 5) == "92", "2001 <= 5000",
  ifelse(substr(cusec, 4, 5) == "93", "5001 <= 10000",
  ifelse(substr(cusec, 4, 5) == "94", "10001 <= 20000","Otros"))))

df_rural <- data.frame(MUN_LITERAL, cusec)

# Obtener nombres de todos los municipios y provincias
locations <- read_excel("vivienda turística/exp_viv_turistica_tabla5_FEB2021.xlsx", sheet = 3, na = "Dato protegido por secreto estadístico.")

nombres_municipios <- locations |> 
  select(MUN_LITERAL, MUN) |> 
  rename(cusec = MUN) |> 
  distinct(cusec, .keep_all = TRUE)

nombres_provincias <- locations |> 
  select(PROV_LITERAL, PROV) |> 
  rename(CPRO = PROV) |> 
  distinct(CPRO, .keep_all = TRUE)

nombres_municipios <- rbind(nombres_municipios, df_rural)

# Crear nombres CCAA
ccaas <- data.frame(
  CodigoProvincia = c("01", "02", "03", "04", "33", "05", "06", "08", "09", "10", "11", "39", "12", "13", "14", "16", "17", "18", "19", "20", "21", "22", "23", "07", "24", "15", "35", "25", "26", "27", "28", "29", "30", "31", "32", "34", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49", "50", "51", "52"),
  CCAA = c("País Vasco", "Castilla-La Mancha", "Comunidad Valenciana", "Andalucía", "Asturias", "Castilla y León", "Extremadura", "Cataluña", "Castilla y León", "Extremadura", "Andalucía", "Cantabria", "Comunidad Valenciana", "Castilla-La Mancha", "Andalucía", "Castilla-La Mancha", "Cataluña", "Andalucía", "Castilla-La Mancha", "País Vasco", "Andalucía", "Aragón", "Andalucía", "Islas Baleares", "Castilla y León", "Galicia", "Canarias", "Cataluña", "La Rioja", "Galicia", "Comunidad de Madrid", "Andalucía", "Comunidad de Murcia", "Comunidad Foral de Navarra", "Galicia", "Castilla y León", "Galicia", "Castilla y León", "Canarias", "Cantabria", "Castilla y León", "Andalucía", "Castilla y León", "Cataluña", "Aragón", "Castilla-La Mancha", "Comunidad Valenciana", "Castilla y León", "País Vasco", "Castilla y León", "Aragón", "Ceuta", "Melilla"))

# Añadir nombres de provincias y municipios a cada cusec
propiedad <- propiedad |> 
  mutate(
    CMUN = str_pad(CMUN, width = 3, side = "left", pad = "0"),
    CPRO = str_pad(CPRO, width = 2, side = "left", pad = "0")) |> 
   mutate(  
    CPRO = trimws(CPRO),
    CMUN = trimws(CMUN),
    cusec = paste0(CPRO, CMUN)) |> 
  left_join(nombres_municipios, by = "cusec") |> 
  left_join(nombres_provincias, by = "CPRO") |> 
  left_join(ccaas, by = c("CPRO" = "CodigoProvincia")) |> 
  distinct(cusec, .keep_all = T)

```

### Municipios rurales

Aquí se solucionan unas pequeñas discrepancias entre los municipios del Censo del 2011 y 2021. Se deben a que los municipios en 2011 entre 10000 a 20000 habitantes están agrupados dentro del código "994", pero en 2021 éstos tienen su nombre completo. Además, algunos municipios se encuentran en el límite de haber pasado una de las barreras de estos códigos entre ambos años y provoca algunos pequeños desajustes.

Datos de población: Padrón municipal e INE. <https://www.ine.es/dynt3/inebase/es/index.htm?padre=525>

```{r}

# Cargar datos 2021
load("Microdatos2021/Personas/R/CensoPersonas_2021.RData")

microdatos2021 <- Microdatos

# Obtener todos los municipios de 2021
mun21 <- microdatos2021 |> 
  select(CPRO, CMUN) |>    
  mutate(CPRO = trimws(CPRO), CMUN = trimws(CMUN), cusec = paste0(CPRO, CMUN)) |> 
  distinct(cusec)

# Obtener todos los municipios de 2011
mun11 <- microdatos2011 |> 
  select(CPRO, CMUN) |> 
   mutate(
    CMUN = str_pad(CMUN, width = 3, side = "left", pad = "0"),
    CPRO = str_pad(CPRO, width = 2, side = "left", pad = "0")) |>
   mutate(CPRO = trimws(CPRO), CMUN = trimws(CMUN), cusec = paste0(CPRO, CMUN)) |> 
  distinct(cusec)

# These are the municipalities lost from 2021 to 2011. 
# Municipalities from 10000 to 20000 inhabitants
municipios994 <- mun21 |> 
  anti_join(mun11, by = "cusec") |> 
  mutate(cusec_994 = cusec)

mun_994 <- municipios994 |> 
  mutate(cusec = paste0(substr(cusec, 1, 2), "994")) 


# Asignar código a municipios según su población 2011
poblacion_mun11 <- read_xls("Población/pobmun11.xls")

poblacion_mun11 <- poblacion_mun11 |> 
  setNames(poblacion_mun11[1, ]) |> 
      slice(-1) |> 
    select(-c(MUJERES, VARONES)) |> 
  rename(Poblacion2011 = `AMBOS SEXOS`) |> 
    mutate(CPRO = trimws(CPRO), CMUN = trimws(CMUN), cusec = paste0(CPRO, CMUN)) 

cusec_rural_2011 <- poblacion_mun11 |> 
  mutate(Poblacion2011 = as.numeric(Poblacion2011)) |> 
  filter(Poblacion2011 < 20000) |> 
  mutate(cusec_original = cusec,
    cusec = case_when(
      Poblacion2011 < 2000 ~ paste0(substr(cusec_original, 1, 2), "991"),
      Poblacion2011 < 5000 ~ paste0(substr(cusec_original, 1, 2), "992"),
      Poblacion2011 < 10000 ~ paste0(substr(cusec_original, 1, 2), "993"),
      Poblacion2011 < 20000 ~ paste0(substr(cusec_original, 1, 2), "994"),
      TRUE ~ cusec
    )
  )

cusec_rural_2011 <- cusec_rural_2011 |> 
  distinct(cusec_original, .keep_all = TRUE) |> 
  select(cusec_original, cusec)


# Asignar código a municipios según su población 2021
poblacion_mun21 <- read_xlsx("Población/pobmun21.xlsx")

poblacion_mun21 <- poblacion_mun21 |> 
  setNames(poblacion_mun21[1, ]) |> 
      slice(-1) |> 
    select(-c(MUJERES, HOMBRES)) |> 
  rename(Poblacion2021 = `POB21`) |> 
    mutate(CPRO = trimws(CPRO), CMUN = trimws(CMUN), cusec = paste0(CPRO, CMUN)) 

cusec_rural_2021 <- poblacion_mun21 |> 
  mutate(Poblacion2021 = as.numeric(Poblacion2021)) |> 
  filter(Poblacion2021 < 20000) |> 
  mutate(cusec_original = cusec,
    cusec = case_when(
      Poblacion2021 < 2000 ~ paste0(substr(cusec_original, 1, 2), "991"),
      Poblacion2021 < 5000 ~ paste0(substr(cusec_original, 1, 2), "992"),
      Poblacion2021 < 10000 ~ paste0(substr(cusec_original, 1, 2), "993"),
      Poblacion2021 < 20000 ~ paste0(substr(cusec_original, 1, 2), "994"),
      TRUE ~ cusec
    )
  )

cusec_rural_2021 <- cusec_rural_2021 |> 
  distinct(cusec_original, .keep_all = TRUE) |> 
  select(cusec_original, cusec)

```

## Filtrar población objetivo

### 2011

```{r}

# Seleccionar variables 2011
compra11 <- microdatos2011 |> 
  select(CPRO, CMUN, EDAD, ANAC, NORDEN, ANORES, TENEN, OPA_NORDEN, TIPOPER, ESTHOG, EDADPAD, EDADMAD) 

# Filtrar población objetivo
compra11 <- compra11 |> 
  filter(EDAD %in% c(18:35), # Jóvenes
         TIPOPER != "H", # Que no son hijos en el núcleo
         is.na(EDADPAD), # Que no conviven con el padre
         is.na(EDADMAD)) |> # Que no conviven con la madre 
    select(-EDADPAD, -EDADMAD) |> 
  filter(ESTHOG %in% c(01, 02, 05, 07, 08, 10, 11)) # No es un hogar con una persona sola de +65 años ni hijos de más de 25

compra11 <- compra11 |> 
  mutate(mayor = ifelse(ANORES - ANAC > 18, TRUE, FALSE)) |> 
  filter(mayor == TRUE) # Que era mayor de edad en la última mudanza
  
compra11 <- compra11 |> 
  filter(NORDEN %in% c(1, 2)) # Que es orden 1 o 2 en el núcleo

#Recodificar tenen viv
compra11 <- compra11 |>  
  mutate(
    TENEN_r = case_when(
      TENEN == 1 ~ "Propiedad por compra, pagada",
      TENEN == 2 ~ "Propiedad por compra, pagos pendientes",
      TENEN == 3 ~ "Propiedad por herencia o donación",
      TENEN == 4 ~ "Alquiler",
      TENEN == 5 ~ "Cedida o a bajo precio",
      TENEN == 6 ~ "Otro")) |> 
  mutate(
    TENEN_VIV = case_when(
      TENEN_r %in% c("Propiedad por compra, pagada", "Propiedad por compra, pagos pendientes") ~ "Compra",
      TENEN_r == "Propiedad por herencia o donación" ~ "Herencia o donación",
      TENEN_r == "Alquiler" ~ "Alquiler",
      TENEN_r %in% c("Cedida o a bajo precio", "Otro") ~ "Otro"))

# Poner cusec
compra11 <- compra11 |>  
  mutate(
    CMUN = str_pad(CMUN, width = 3, side = "left", pad = "0"),
    CPRO = str_pad(CPRO, width = 2, side = "left", pad = "0")) |> 
   mutate(  
    CPRO = trimws(CPRO),
    CMUN = trimws(CMUN),
    cusec = paste0(CPRO, CMUN))

compra11 <- compra11 |> 
  left_join(nombres_municipios, by = "cusec") |> 
  left_join(nombres_provincias, by = "CPRO") |> 
  left_join(ccaas, by = c("CPRO" = "CodigoProvincia"))


```

### 2021

```{r}
# 2021
compra21 <- microdatos2021 |> 
  select(CPRO, CMUN, VAREDAD, ANAC, TENEN_VIV, NORDEN, RESI_NACIM, VARANORES, VARANOM, CMUN_ANT, CMUN_UNANO, RESI_UNANO, CMUN_DANO, RESI_DANO, LTRAB, CMUN_TRAB, LEST, CMUN_EST, NORDEN_CON, NORDEN_OPA, TIPOPER, SEXO_MAD, SEXO_PAD, ESTRUC_HOG) 

compra21 <- compra21 |> 
  filter(VAREDAD %in% c(18:35), # Jóvenes
         TIPOPER != "H", # Que no son hijos en el núcleo
         SEXO_PAD == "N", # Que no conviven con el padre
         SEXO_MAD == "N") |>  # Que no conviven con la madre
  mutate(ESTRUC_HOG = as.numeric(ESTRUC_HOG)) |> 
  filter(ESTRUC_HOG %in% c(01, 02, 05, 07, 08, 10, 11)) # No es un hogar con una persona sola de +65 años ni hijos de más de 25

# Filtrar para haberse mudado a otra vivienda con mínimo 18 años, en una forma amplia 
compra21 <- compra21 |> 
  mutate(
    VARANORES_r = case_when(
      VARANORES == "0005" ~ as.numeric(2015),
      VARANORES == "0004" ~ as.numeric(2010),
      VARANORES %in% c("9999", "0003") ~ as.numeric(2000), 
      VARANORES == " " ~ NA,
      TRUE ~ as.numeric(VARANORES)),
      ANAC = as.numeric(ANAC),
      mayor = ifelse(VARANORES_r - ANAC > 18, TRUE, FALSE)) |> 
  filter(mayor == TRUE)

compra21 <- compra21 |> 
  filter(NORDEN %in% c("01", "02")) # Que es orden 1 o 2 en el núcleo

# Recodificar código de tenencia
compra21 <- compra21 |> 
    mutate(
    TENEN_VIV = case_when(
      TENEN_VIV == 2 ~ "Propiedad",
      TENEN_VIV == 3 ~ "Alquiler",
      TENEN_VIV == 4 ~ "Otro")) 

# Poner cusec
compra21 <- compra21 |> 
  mutate(CPRO = trimws(CPRO), CMUN = trimws(CMUN), cusec = paste0(CPRO, CMUN))

compra21 <- compra21 |> 
  left_join(nombres_municipios, by = "cusec") |> 
  left_join(nombres_provincias, by = "CPRO") |> 
  left_join(ccaas, by = c("CPRO" = "CodigoProvincia"))



```

## Crear variables por año

### 2011

```{r}

# Solucionar algunos errores en esos municipios
propiedad <- propiedad %>%
  mutate(CPRO = case_when(
    MUN_LITERAL == "Baena" ~ "14",
    MUN_LITERAL == "Barañain" ~ "31",
    cusec == "47994" ~ "47",
    MUN_LITERAL == "Calatayud" ~ "50",
    TRUE ~ CPRO))

# Poner nombres de CCAA
compra11<-compra11 |> 
  left_join(ccaas, by = c("CPRO" = "CodigoProvincia")) 

# Variables de régimen de tenencia por municipio
compra11 <- compra11 |>
  group_by(cusec) |>
  mutate(
    Compra11Mun = round((sum(TENEN_VIV == "Compra") / n()) * 100, 2),
    Propiedad11Mun = round((sum(TENEN_VIV %in% c("Compra", "Herencia o donación")) / n()) * 100, 2),
    Herencia11Mun = round((sum(TENEN_VIV == "Herencia o donación") / n()) * 100, 2),
    Alquiler11Mun = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro11Mun = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2)
  ) |>
  ungroup()

# Por provincia
compra11 <- compra11 |>
  group_by(CPRO) |>
  mutate(
    Compra11Prov = round((sum(TENEN_VIV == "Compra") / n()) * 100, 2),
    Propiedad11Prov = round((sum(TENEN_VIV %in% c("Compra", "Herencia o donación")) / n()) * 100, 2),
    Herencia11Prov = round((sum(TENEN_VIV == "Herencia o donación") / n()) * 100, 2),
    Alquiler11Prov = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro11Prov = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2)
  ) |> 
  ungroup()


compra11<-compra11 |> 
  left_join(ccaas, by = c("CPRO" = "CodigoProvincia")) 

# Por CCAA
compra11 <- compra11 |>
  group_by(CCAA) |>
  mutate(
     Compra11CCAA = round((sum(TENEN_VIV == "Compra") / n()) * 100, 2),
    Propiedad11CCAA = round((sum(TENEN_VIV %in% c("Compra", "Herencia o donación")) / n()) * 100, 2),
    Herencia11CCAA = round((sum(TENEN_VIV == "Herencia o donación") / n()) * 100, 2),
    Alquiler11CCAA = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
  Otro11CCAA = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2)) |>
  ungroup()

```

### 2021

```{r}

# Añadir CCAA
compra21<-compra21 |> 
  left_join(ccaas, by = c("CPRO" = "CodigoProvincia")) 

# Por municipio
compra21 <- compra21 |> 
  group_by(cusec) |> 
  mutate(
    Propiedad21Mun = round((sum(TENEN_VIV == "Propiedad") / n()) * 100, 2),
    Alquiler21Mun = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro21Mun = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2)) |> 
  ungroup()

# Por provincia
compra21 <- compra21 |>
  group_by(CPRO) |>
  mutate(
    Propiedad21Prov = round((sum(TENEN_VIV == "Propiedad") / n()) * 100, 2),
    Alquiler21Prov = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro21Prov = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2)
  ) |> 
  ungroup() 

# Por CCAA
compra21 <- compra21 |>
  group_by(CCAA) |>
  mutate(
    Propiedad21CCAA = round((sum(TENEN_VIV == "Propiedad") / n()) * 100, 2),
    Alquiler21CCAA = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro21CCAA = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2)
  ) |> 
  ungroup() 

# Juntar pequeños municipios (994)
compra21 <- compra21 |> 
  left_join(cusec_rural_2021, by = c("cusec" = "cusec_original")) |> 
  mutate(cusec = coalesce(cusec.y, cusec)) |> 
  select(-cusec.y) |> 
  group_by(cusec) |> # Group all small mun together by province 
  mutate(Propiedad21Mun = round(mean(Propiedad21Mun), 2),
            Alquiler21Mun = round(mean(Alquiler21Mun), 2),
            Otro21Mun = round(mean(Otro21Mun), 2)) |> 
  ungroup() 

```

## Crear diferencias

```{r}

write.xlsx(compra11, "compra11.xlsx")
write.xlsx(compra21, "compra21.xlsx")

# Seleccionar sólo variables de régimen de tenencias
tenencia11 <- compra11 |> 
  select(cusec, CPRO, Compra11Mun, Propiedad11Mun, Herencia11Mun, Alquiler11Mun, Otro11Mun, Propiedad11Prov, Herencia11Prov, Alquiler11Prov, Otro11Prov, Propiedad11CCAA, Herencia11CCAA, Alquiler11CCAA, Otro11CCAA) |> 
  distinct(cusec, .keep_all = T)

tenencia21 <- compra21 |> 
  select(cusec, CPRO, Propiedad21Mun, Alquiler21Mun, Otro21Mun, Propiedad21Prov, Alquiler21Prov, Otro21Prov, Propiedad21CCAA, Alquiler21CCAA, Otro21CCAA) |> 
  distinct(cusec, .keep_all = T)

# Juntar ambos años
tenencias <- tenencia11 |> 
  left_join(tenencia21, by = "cusec")

# Crear diferencias
tenencias <- tenencias |> 
  mutate(
    PropiedadDifMun = Propiedad21Mun - Propiedad11Mun,
    AlquilerDifMun = Alquiler21Mun - Alquiler11Mun,
    OtroDifMun = Otro21Mun - Otro11Mun,
    PropiedadDifProv = Propiedad21Prov - Propiedad11Prov,
    AlquilerDifProv = Alquiler21Prov - Alquiler11Prov,
    OtroDifProv = Otro21Prov - Otro11Prov,
    PropiedadDifCCAA = Propiedad21CCAA - Propiedad11CCAA,
    AlquilerDifCCAA = Alquiler21CCAA - Alquiler11CCAA,
    OtroDifCCAA = Otro21CCAA - Otro11CCAA)

# DATABASE FINAL
propiedad <- propiedad |> 
  left_join(tenencias, by = "cusec") |> 
  distinct(cusec, .keep_all=T) |> 
  select(-CPRO.y) |> 
  mutate(CPRO=CPRO.X) |> 
  select(-CPRO.x)


library(openxlsx)
write.xlsx(propiedad, "propiedad.xlsx")

```

# -

# Descriptivo

## En 2011

### Por municipio

```{r}

# Para no tener que ejecutar todo el código anterior
propiedad <- read_xlsx("propiedad.xlsx")

# Propiedad
top_propiedad_2011 <- propiedad %>%
  arrange(desc(Propiedad11Mun)) %>%
  distinct(Propiedad11Mun, .keep_all = TRUE) |> 
  select(Propiedad11Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

# Compra
top_compra_2011 <- propiedad %>%
  arrange(desc(Compra11Mun)) %>%
  distinct(Compra11Mun, .keep_all = TRUE) |> 
  select(Compra11Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

# Herencia
top_herencia_2011 <- propiedad %>%
  arrange(desc(Herencia11Mun)) %>%
  distinct(cusec, .keep_all = TRUE) |> 
  select(Herencia11Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

# Alquiler
top_alquiler_2011 <- propiedad %>%
  arrange(desc(Alquiler11Mun)) %>%
  distinct(cusec, .keep_all = TRUE) |> 
  select(Alquiler11Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

# Otro
top_otro_2011 <- propiedad %>%
  arrange(desc(Otro11Mun)) %>%
  distinct(cusec, .keep_all = TRUE) |> 
  select(Otro11Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

top_propiedad_2011
top_compra_2011
top_herencia_2011
top_alquiler_2011
top_otro_2011

```

### Por provincia

```{r}

# Propiedad
top_propiedad_2011 <- propiedad |> 
    distinct(CPRO, .keep_all = TRUE) |> 
    arrange(desc(Propiedad11Prov)) |> 
    select(Herencia11Prov, PROV_LITERAL, CCAA)

# Compra
top_compra_2011 <- propiedad |> 
    distinct(CPRO, .keep_all = TRUE) |> 
    arrange(desc(Compra11Prov)) |> 
    select(Compra11Prov, PROV_LITERAL, CCAA)

# Herencia
top_herencia_2011 <- propiedad |> 
    distinct(CPRO, .keep_all = TRUE) |> 
    arrange(desc(Herencia11Prov)) |> 
    select(Herencia11Prov, PROV_LITERAL, CCAA)

# Alquiler
top_alquiler_2011 <- propiedad %>%
  arrange(desc(Alquiler11Prov)) %>%
  distinct(CPRO, .keep_all = TRUE) |> 
  select(Alquiler11Prov, PROV_LITERAL, CCAA)

# Otro
top_otro_2011 <- propiedad %>%
  arrange(desc(Otro11Prov)) %>%
  distinct(CPRO, .keep_all = TRUE) |> 
  select(Otro11Prov, PROV_LITERAL, CCAA)

top_compra_2011
top_herencia_2011
top_alquiler_2011
top_otro_2011
```

### Por CCAA

```{r}

# Propiedad
top_propiedad_2011 <- propiedad |> 
    distinct(CPRO, .keep_all = TRUE) |> 
    arrange(desc(Propiedad11CCAA)) |> 
    select(Herencia11Prov, PROV_LITERAL, CCAA)

# Compra
top_compra_2011 <- propiedad |> 
    distinct(CCAA, .keep_all = TRUE) |> 
    arrange(desc(Compra11CCAA)) |> 
    select(Compra11CCAA, CCAA)

# Herencia
top_herencia_2011 <- propiedad |> 
    distinct(CCAA, .keep_all = TRUE) |> 
    arrange(desc(Herencia11CCAA)) |> 
    select(Herencia11CCAA, CCAA)

# Alquiler
top_alquiler_2011 <- compra11 %>%
  arrange(desc(Alquiler11CCAA)) %>%
  distinct(CCAA, .keep_all = TRUE) |> 
  select(Alquiler11CCAA, CCAA)

# Otro
top_otro_2011 <- compra11 %>%
  arrange(desc(Otro11CCAA)) %>%
  distinct(CCAA, .keep_all = TRUE) |> 
  select(Otro11CCAA, CCAA)

top_propiedad_2011
top_compra_2011
top_herencia_2011
top_alquiler_2011
top_otro_2011
```

## En 2021

### Por municipio

```{r}
# Propiedad
top_propiedad_2021 <- propiedad |> 
    distinct(cusec, .keep_all = TRUE) |> 
    arrange(desc(Propiedad21Mun)) |> 
    select(Propiedad21Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

# Alquiler
top_alquiler_2021 <- propiedad |> 
    distinct(cusec, .keep_all = TRUE) |> 
    arrange(desc(Alquiler21Mun)) |> 
    select(Alquiler21Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

# Otro
top_otro_2021 <- propiedad |> 
    distinct(cusec, .keep_all = TRUE) |> 
    arrange(desc(Otro21Mun)) |> 
    select(Propiedad21Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

top_propiedad_2021
top_alquiler_2021
top_otro_2021

```

### Por provincia

```{r}

# Propiedad
top_propiedad_2021 <- propiedad |> 
    distinct(CPRO, .keep_all = TRUE) |> 
    arrange(desc(Propiedad21Prov)) |> 
    select(Propiedad21Prov, PROV_LITERAL, CCAA)

# Alquiler
top_alquiler_2021 <- propiedad |> 
    distinct(CPRO, .keep_all = TRUE) |> 
    arrange(desc(Alquiler21Prov)) |> 
    select(Alquiler21Prov, PROV_LITERAL, CCAA)

# Otro
top_otro_2021 <- propiedad |> 
    distinct(CPRO, .keep_all = TRUE) |> 
    arrange(desc(Otro21Prov)) |> 
    select(Propiedad21Mun, PROV_LITERAL, CCAA)

top_propiedad_2021
top_alquiler_2021
top_otro_2021
```

### Por CCAA

```{r}

# Propiedad
top_propiedad_2021 <- propiedad |> 
    distinct(CCAA, .keep_all = TRUE) |> 
    arrange(desc(Propiedad21CCAA)) |> 
    select(Propiedad21CCAA, CCAA)

# Alquiler
top_propiedad_2021 <- propiedad |> 
    distinct(CCAA, .keep_all = TRUE) |> 
    arrange(desc(Alquiler21CCAA)) |> 
    select(Alquiler21CCAA, CCAA)

# Otro
top_propiedad_2021 <- propiedad |> 
    distinct(CCAA, .keep_all = TRUE) |> 
    arrange(desc(Otro21CCAA)) |> 
    select(Otro21CCAA, CCAA)

top_propiedad_2021
top_alquiler_2021
top_otro_2021
```

## Diferencia

### Por municipio

```{r}
# Propiedad
top_propiedad_dif <- propiedad |> 
    distinct(cusec, .keep_all = TRUE) |> 
    arrange(desc(PropiedadDifMun)) |> 
  select(MUN_LITERAL, PROV_LITERAL, PropiedadDifMun, AlquilerDifMun, OtroDifMun, Herencia11Mun) |> 
  filter(PropiedadDifMun > 5)

# Alquiler
top_alquiler_dif <- propiedad |> 
    distinct(cusec, .keep_all = TRUE) |> 
    arrange(desc(AlquilerDifMun)) |> 
    select(Alquiler21Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

# Otro
top_otro_dif <- propiedad |> 
    distinct(cusec, .keep_all = TRUE) |> 
    arrange(desc(OtroDifMun)) |> 
    select(Propiedad21Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

top_propiedad_dif
top_alquiler_dif
top_otro_dif

# Save top dif table
ft <- flextable(top_propiedad_dif)
ft <- autofit(ft)
save_as_image(x = ft, path = paste0(getwd(), "/tablatopdif.png"))

# Sabe bot dif table
bot_propiedad_dif <- propiedad |> 
    distinct(cusec, .keep_all = TRUE) |> 
    arrange(PropiedadDifMun) |> 
  select(MUN_LITERAL, PROV_LITERAL, PropiedadDifMun, AlquilerDifMun, OtroDifMun) |> 
  filter(PropiedadDifMun < -28)

ft <- flextable(bot_propiedad_dif)
ft <- autofit(ft)
save_as_image(x = ft, path = paste0(getwd(), "/tablabotdif.png"))

# Graphs

ggplot(top_propiedad_dif, aes(x = reorder(MUN_LITERAL, PropiedadDifMun), y = PropiedadDifMun, fill = "Propiedad")) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_bar(aes(y = AlquilerDifMun, fill = "Alquiler"), stat = "identity", position = "dodge") +
  geom_bar(aes(y = OtroDifMun, fill = "Otro"), stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("Propiedad" = "skyblue2", "Alquiler" = "green3", "Otro" = "red2")) +
  labs(title = "Cambios en Propiedad, Alquiler y Otro por Municipio",
       x = "Municipio",
       y = "Cambios",
       fill = "Tipo de Cambio") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  guides(fill = guide_legend(title = "Tipo de Cambio")) +
  coord_flip()+
  theme_minimal()

ggplot(bot_propiedad_dif, aes(x = reorder(MUN_LITERAL, PropiedadDifMun), y = PropiedadDifMun, fill = "Propiedad")) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_bar(aes(y = AlquilerDifMun, fill = "Alquiler"), stat = "identity", position = "dodge") +
  geom_bar(aes(y = OtroDifMun, fill = "Otro"), stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("Propiedad" = "skyblue2", "Alquiler" = "green3", "Otro" = "red2")) +
  labs(title = "Cambios en Propiedad, Alquiler y Otro por Municipio",
       x = "Municipio",
       y = "Cambios",
       fill = "Tipo de Cambio") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  guides(fill = guide_legend(title = "Tipo de Cambio")) +
  coord_flip()+
  theme_minimal()

```

# Mapas

## En 2011

### Por provincia

```{r, fig.height=8, fig.width=14}

library(mapSpain)
  
esp_can <- esp_get_country() 
can_prov <- esp_get_can_provinces()
can_box <- esp_get_can_box() 
munic <- esp_get_munic() 

provic <- esp_get_prov() |> 
  mutate(CPRO = cpro)

# Propiedad
mapa <- propiedad |> 
  select(CPRO, Propiedad11Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p1 <- ggplot(esp_can) +
  geom_sf(color = "black", size = 0.7) +  
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Propiedad11Prov), color = "black", size = 0.3) +  
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "white") +  
  geom_sf_text(data = mapa, aes(label = round(Propiedad11Prov, 1), color = ifelse(Propiedad11Prov > 75, "white", "black")), 
               size = 2.4, check_overlap = TRUE, nudge_y = -0.03) + 
  theme_void() +  
  labs(title = "% of Young People in 'Property' Residence Status in 2011") +  
  theme(
    legend.position = "none",
    plot.title = element_text(family = "Calibri", size = 14),
    text = element_text(family = "Calibri"),
        plot.background = element_rect(fill = "white", color = NA),  # Fondo blanco para la figura
    panel.background = element_rect(fill = "white", color = NA)  # Fondo blanco para el panel
  ) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1) +
  scale_color_identity()  

# Herencia o donación

mapa <- propiedad |> 
  select(CPRO, Herencia11Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p2 <- ggplot(esp_can) +
  geom_sf(color = "black", size = 0.7) +  
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Herencia11Prov), color = "black", size = 0.3) +  
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "white") +  
  geom_sf_text(data = mapa, aes(label = round(Herencia11Prov, 1)), 
               color = "black", size = 2.4, check_overlap = TRUE, nudge_y = -0.03) + 
  theme_void() +  
  labs(title = "% of Young People in 'Inheritance/Donation' Residence Status in 2011") +  
  theme(
    legend.position = "none",
    plot.title = element_text(family = "Calibri", size = 14),
    text = element_text(family = "Calibri"),
        plot.background = element_rect(fill = "white", color = NA),  # Fondo blanco para la figura
    panel.background = element_rect(fill = "white", color = NA)  # Fondo blanco para el panel
  ) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1)

# Alquiler
mapa <- propiedad |> 
  select(CPRO, Alquiler11Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p3 <- ggplot(esp_can) +
  geom_sf(color = "black", size = 0.7) +  
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Alquiler11Prov), color = "black", size = 0.3) +  
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "white") +  
  geom_sf_text(data = mapa, aes(label = round(Alquiler11Prov, 1)), 
               color = "black", size = 2.4, check_overlap = TRUE, nudge_y = -0.03) + 
  theme_void() +  
  labs(title = "% of Young People in 'Rent' Residence Status in 2011") +  
  theme(
    legend.position = "none",
    plot.title = element_text(family = "Calibri", size = 14),
    text = element_text(family = "Calibri"),
    plot.background = element_rect(fill = "white", color = NA),  # Fondo blanco para la figura
    panel.background = element_rect(fill = "white", color = NA)  # Fondo blanco para el panel
) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1)

# Otro
mapa <- propiedad |> 
  select(CPRO, Otro11Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p4 <- ggplot(esp_can) +
  geom_sf(color = "black", size = 0.7) +  
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Otro11Prov), color = "black", size = 0.3) +  
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "white") +  
  geom_sf_text(data = mapa, aes(label = round(Otro11Prov, 1)), 
               color = "black", size = 2.4, check_overlap = TRUE, nudge_y = -0.03) + 
  theme_void() +  
  labs(title = "% of Young People in 'Other' Residence Status in 2011") +  
  theme(
    legend.position = "none",
    plot.title = element_text(family = "Calibri", size = 14),
    text = element_text(family = "Calibri"),
    plot.background = element_rect(fill = "white", color = NA),  # Fondo blanco para la figura
    panel.background = element_rect(fill = "white", color = NA)  # Fondo blanco para el panel
  ) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1)

p1 <- p1 + theme(plot.margin = margin(5, 5, 5, 5))
p2 <- p2 + theme(plot.margin = margin(5, 5, 5, 5))
p3 <- p3 + theme(plot.margin = margin(5, 5, 5, 5))
p4 <- p4 + theme(plot.margin = margin(5, 5, 5, 5))

combined_plot <- ggarrange(p1, p2, p3, p4, ncol = 2, nrow = 2)

# Guardar el gráfico combinado con fondo blanco
ggsave("2011.png", plot = combined_plot, width = 12, height = 8, bg = "white")


ccaa <- esp_get_ccaa(ccaa = c())

```

### Por CCAA

```{r}
library(mapSpain)
  
esp_can <- esp_get_country() 
can_box <- esp_get_can_box() 
munic <- esp_get_munic() 
ccaa <- esp_get_ccaa()


ccaa <- esp_get_prov() |> 
  mutate(CCAA = "ine.ccaa.name")

# Propiedad
mapa <- propiedad |> 
  select(CCAA, Propiedad11CCAA) |> 
  distinct(CCAA, .keep_all = TRUE)

mapa <- ccaa |> 
  left_join(mapa, by = "CCAA")

p1 <- ggplot(esp_can) +
  geom_sf(color = "black", size = 0.7) +  
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Propiedad11CCAA), color = "black", size = 0.3) +  
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "white") +  
  geom_sf_text(data = mapa, aes(label = round(Propiedad11CCAA, 1), color = ifelse(Propiedad11CCAA > 75, "white", "black")), 
               size = 2.4, check_overlap = TRUE, nudge_y = -0.03) + 
  theme_void() +  
  labs(title = "% of Young People in 'Property' Residence Status in 2011") +  
  theme(
    legend.position = "none",
    plot.title = element_text(family = "Calibri", size = 14),
    text = element_text(family = "Calibri"),
        plot.background = element_rect(fill = "white", color = NA),  # Fondo blanco para la figura
    panel.background = element_rect(fill = "white", color = NA)  # Fondo blanco para el panel
  ) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1) +
  scale_color_identity()  

# Herencia o donación

mapa <- propiedad |> 
  select(CPRO, Herencia11Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p2 <- ggplot(esp_can) +
  geom_sf(color = "black", size = 0.7) +  
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Herencia11Prov), color = "black", size = 0.3) +  
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "white") +  
  geom_sf_text(data = mapa, aes(label = round(Herencia11Prov, 1)), 
               color = "black", size = 2.4, check_overlap = TRUE, nudge_y = -0.03) + 
  theme_void() +  
  labs(title = "% of Young People in 'Inheritance/Donation' Residence Status in 2011") +  
  theme(
    legend.position = "none",
    plot.title = element_text(family = "Calibri", size = 14),
    text = element_text(family = "Calibri"),
        plot.background = element_rect(fill = "white", color = NA),  # Fondo blanco para la figura
    panel.background = element_rect(fill = "white", color = NA)  # Fondo blanco para el panel
  ) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1)

# Alquiler
mapa <- propiedad |> 
  select(CPRO, Alquiler11Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p3 <- ggplot(esp_can) +
  geom_sf(color = "black", size = 0.7) +  
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Alquiler11Prov), color = "black", size = 0.3) +  
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "white") +  
  geom_sf_text(data = mapa, aes(label = round(Alquiler11Prov, 1)), 
               color = "black", size = 2.4, check_overlap = TRUE, nudge_y = -0.03) + 
  theme_void() +  
  labs(title = "% of Young People in 'Rent' Residence Status in 2011") +  
  theme(
    legend.position = "none",
    plot.title = element_text(family = "Calibri", size = 14),
    text = element_text(family = "Calibri"),
    plot.background = element_rect(fill = "white", color = NA),  # Fondo blanco para la figura
    panel.background = element_rect(fill = "white", color = NA)  # Fondo blanco para el panel
) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1)

# Otro
mapa <- propiedad |> 
  select(CPRO, Otro11Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p4 <- ggplot(esp_can) +
  geom_sf(color = "black", size = 0.7) +  
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Otro11Prov), color = "black", size = 0.3) +  
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "white") +  
  geom_sf_text(data = mapa, aes(label = round(Otro11Prov, 1)), 
               color = "black", size = 2.4, check_overlap = TRUE, nudge_y = -0.03) + 
  theme_void() +  
  labs(title = "% of Young People in 'Other' Residence Status in 2011") +  
  theme(
    legend.position = "none",
    plot.title = element_text(family = "Calibri", size = 14),
    text = element_text(family = "Calibri"),
    plot.background = element_rect(fill = "white", color = NA),  # Fondo blanco para la figura
    panel.background = element_rect(fill = "white", color = NA)  # Fondo blanco para el panel
  ) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1)

p1 <- p1 + theme(plot.margin = margin(5, 5, 5, 5))
p2 <- p2 + theme(plot.margin = margin(5, 5, 5, 5))
p3 <- p3 + theme(plot.margin = margin(5, 5, 5, 5))
p4 <- p4 + theme(plot.margin = margin(5, 5, 5, 5))

combined_plot <- ggarrange(p1, p2, p3, p4, ncol = 2, nrow = 2)

# Guardar el gráfico combinado con fondo blanco
ggsave("2011.png", plot = combined_plot, width = 12, height = 8, bg = "white")
p1

```

## En 2021

### Por provincia

```{r, fig.height=8, fig.width=17}
library(mapSpain)

esp_can <- esp_get_country() 
can_prov <- esp_get_can_provinces()
can_box <- esp_get_can_box() 
munic <- esp_get_munic() 


provic <- esp_get_prov() |> 
  mutate(CPRO = cpro)

mapa <- propiedad |> 
  select(CPRO, Propiedad21Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

# Propiedad
p5 <- ggplot(esp_can) +
  geom_sf(color = "black", size = 0.7) +  
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Propiedad21Prov), color = "black", size = 0.3) +  
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "white") +  
  geom_sf_text(data = mapa, aes(label = round(Propiedad21Prov, 1), color = ifelse(Propiedad21Prov > 75, "white", "black")), 
               size = 2.4, check_overlap = TRUE, nudge_y = -0.03, family = "Montserrat") + 
  theme_void() +  
  labs(title = "% of Young People in 'Property' Residence Status in 2021") +  
  theme(
    legend.position = "none",
    plot.title = element_text(family = "Calibri", size = 14),
    text = element_text(family = "Calibri"),
    plot.background = element_rect(fill = "white", color = NA),  # Fondo blanco para la figura
    panel.background = element_rect(fill = "white", color = NA)  # Fondo blanco para el panel
  ) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1) +
  scale_color_identity()  
 

# Alquiler
mapa <- propiedad |> 
  select(CPRO, Alquiler21Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p6 <- ggplot(esp_can) +
  geom_sf(color = "black", size = 0.7) +  
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Alquiler21Prov), color = "black", size = 0.3) +  
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "white") +  
  geom_sf_text(data = mapa, aes(label = round(Alquiler21Prov, 1), 
                                color = ifelse(Alquiler21Prov > 38, "white", "black")), 
               size = 2.4, check_overlap = TRUE, nudge_y = -0.03, family = "Montserrat") + 
  theme_void() +  
  labs(title = "% of Young People in 'Rent' Residence Status in 2021") +  
  theme(
    legend.position = "none",
    plot.title = element_text(family = "Calibri", size = 14),
    text = element_text(family = "Calibri")) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1) +
  scale_color_identity()  # Añadimos esta escala para manejar los colores definidos manualmente

# Otro
mapa <- propiedad |> 
  select(CPRO, Otro21Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p7 <-ggplot(esp_can) +
  geom_sf(color = "black", size = 0.7) +  
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Otro21Prov), color = "black", size = 0.3) +  
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "white") +  
  geom_sf_text(data = mapa, aes(label = round(Otro21Prov, 1), color = ifelse(Otro21Prov > 19, "white", "black")), size = 2.4, check_overlap = TRUE, nudge_y = -0.03, family = "Montserrat") + 
  theme_void() +  
  labs(title = "% of Young People in 'Other' Residence Status in 2021") +  
  theme(
    legend.position = "none",
    plot.title = element_text(family = "Calibri", size = 14),
    text = element_text(family = "Calibri")) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1) +
  scale_color_identity()  # Añadimos esta escala para manejar los colores definidos manualmente


p1 <- p1 + theme(plot.margin = margin(5, 5, 5, 5))
p2 <- p2 + theme(plot.margin = margin(5, 5, 5, 5))
p3 <- p3 + theme(plot.margin = margin(5, 5, 5, 5))

combined_plot <- ggarrange(p1, p2, p3, ncol = 2, nrow = 2, align = "hv")

# Guardar el gráfico combinado con fondo blanco
ggsave("2021.png", plot = combined_plot, width = 12, height = 8, bg = "white")

```

## Diferencia

### Por municipio

```{r}
library(mapSpain)
  
esp_can <- esp_get_country() 
can_prov <- esp_get_can_provinces()
can_box <- esp_get_can_box() 
munic <- esp_get_munic() 

munic <-    
  munic |>  
  mutate(cusec = LAU_CODE) |> 
  select(geometry, cusec)

# PROPIEDAD

mapa <- propiedad |> 
  select(cusec, PropiedadDifMun)
  
mapa <- munic |> 
  left_join(mapa, by = "cusec")
  

mapa <- mapa |> filter(!is.na(PropiedadDifMun)) 

p1 <- ggplot(esp_can) +
  geom_sf(color = "black", size = 0.7) +  
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = PropiedadDifMun), color = "black", size = 0.3) +  
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "white") +  
  theme_void() +  
  labs(title = "Difference of % of Young People in 'Property' Residence Status in 2011 to 2021") +  
  theme(
    legend.position = "none",
    plot.title = element_text(family = "Calibri", size = 14),
    text = element_text(family = "Calibri")
  ) + 
  coord_sf() +
  scale_fill_gradient2(low = "red", mid = "white", high = "green", midpoint = 0)

#ALQUILER

mapa <- propiedad |> 
  select(cusec, AlquilerDifMun)
  
mapa <- munic |> 
  left_join(mapa, by = "cusec")
  
mapa <- mapa |> filter(!is.na(AlquilerDifMun))

p2 <- ggplot(esp_can) +
  geom_sf(color = "black", size = 0.7) +  
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = AlquilerDifMun), color = "black", size = 0.3) +  
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "white") +  
  theme_void() +  
  labs(title = "Difference of % of Young People in 'Rent' Residence Status in 2011 to 2021") +  
  theme(
    legend.position = "none",
    plot.title = element_text(family = "Calibri", size = 14),
    text = element_text(family = "Calibri")
  ) + 
  coord_sf() +
  scale_fill_gradient2(low = "red", mid = "white", high = "green", midpoint = 0)

p1
p2

ggarrange(p1, p2, ncol = 2, nrow = 1)
```

### Por provincia

```{r, fig.height=8, fig.width=17}
library(mapSpain)

esp_can <- esp_get_country() 
can_prov <- esp_get_can_provinces()
can_box <- esp_get_can_box() 
munic <- esp_get_munic() 

provic <- esp_get_prov() |> 
  mutate(CPRO = cpro)

mapa <- propiedad |> 
  select(CPRO, PropiedadDifProv) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

# Propiedad
  p1 <- ggplot(esp_can) +
  geom_sf(color = "black", size = 0.7) +  
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = PropiedadDifProv), color = "black", size = 0.3) +  
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "white") +  
  geom_sf_text(data = mapa, aes(label = round(PropiedadDifProv, 1)), 
               color = "black", size = 2.4, check_overlap = TRUE, nudge_y = -0.03) + 
  theme_void() +  
  labs(title = "Difference of % of Young People in 'Property' Residence Status in 2011 to 2021") +  
  theme(
    legend.position = "none",
    plot.title = element_text(family = "Calibri", size = 14),
    text = element_text(family = "Calibri")
  ) + 
  coord_sf() +
  scale_fill_gradient2(low = "red", mid = "white", high = "green", midpoint = 0)

# Alquiler
mapa <- propiedad |> 
  select(CPRO, AlquilerDifProv) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p2<- ggplot(esp_can) +
  geom_sf(color = "black", size = 0.7) +  
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = AlquilerDifProv), color = "black", size = 0.3) +  
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "white") +  
  geom_sf_text(data = mapa, aes(label = round(AlquilerDifProv, 1)), color = "black", size = 2.4, check_overlap = TRUE, nudge_y = -0.03, family = "Montserrat") + 
  theme_void() +  
  labs(title = "Difference of % of Young People in 'Rent' Residence Status in 2011 to 2021") +  
  theme(
    legend.position = "none",
    plot.title = element_text(family = "Calibri", size = 14),
    text = element_text(family = "Calibri")) + 
  coord_sf() +
  scale_fill_gradient2(low = "red", mid = "white", high = "green", midpoint = 0)

# Otro
mapa <- propiedad |> 
  select(CPRO, OtroDifProv) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p3 <- ggplot(esp_can) +
  geom_sf(color = "black", size = 0.7) +  
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = OtroDifProv), color = "black", size = 0.3) +  
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "white") +  
  geom_sf_text(data = mapa, aes(label = round(OtroDifProv, 1)), color = "black", size = 2.4, check_overlap = TRUE, nudge_y = -0.03, family = "Montserrat") + 
  theme_void() +  
  labs(title = "Difference of % of Young People in 'Other' Residence Status in 2011 to 2021") +  
  theme(
    legend.position = "none",
    plot.title = element_text(family = "Calibri", size = 14),
    text = element_text(family = "Calibri")) + 
  coord_sf() +
  scale_fill_gradient2(low = "red", mid = "white", high = "green", midpoint = 0)

p1 <- p1 + theme(plot.margin = margin(5, 5, 5, 5))
p2 <- p2 + theme(plot.margin = margin(5, 5, 5, 5))
p3 <- p3 + theme(plot.margin = margin(5, 5, 5, 5))

combined_plot <- ggarrange(p1, p2, p3, ncol = 2, nrow = 2)

# Guardar el gráfico combinado con fondo blanco
ggsave("dif.png", plot = combined_plot, width = 12, height = 8, bg = "white")

mapa <- propiedad |> 
  select(CPRO, PropiedadDifProv) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

# mapa solo propiedad
p1 <- ggplot(esp_can) +
  geom_sf(color = "black", size = 0.7) +  
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = PropiedadDifProv), color = "black", size = 0.3) +  
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "white") +  
  geom_sf_text(data = mapa, aes(label = round(PropiedadDifProv, 1)), 
               color = "black", size = 3.5, check_overlap = TRUE, nudge_y = -0.03) + 
  theme_void() +  
  labs(title = "Difference of % of Young People in 'Property' Residence Status in 2011 to 2021") +  
  theme(
    legend.position = "none",
    plot.title = element_text(family = "Calibri", size = 14),
    text = element_text(family = "Calibri")) + 
  coord_sf() +
  scale_fill_gradient2(low = "red", mid = "white", high = "green", midpoint = 0)

ggsave("difpropiedad.png", plot = p1, width = 12, height = 8, bg = "white")


# mapa propiedad y alquiler
mapa <- propiedad |> 
  select(CPRO, PropiedadDifProv) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

# Propiedad
  p1 <- ggplot(esp_can) +
  geom_sf(color = "black", size = 0.7) +  
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = PropiedadDifProv), color = "black", size = 0.3) +  
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "white") +  
  geom_sf_text(data = mapa, aes(label = round(PropiedadDifProv, 1)), 
               color = "black", size = 2.4, check_overlap = TRUE, nudge_y = -0.03) + 
  theme_void() +  
  labs(title = "Difference of % of Young People in 'Property' Residence Status in 2011 to 2021") +  
  theme(
    legend.position = "none",
    plot.title = element_text(family = "Calibri", size = 14),
    text = element_text(family = "Calibri")
  ) + 
  coord_sf() +
  scale_fill_gradient2(low = "red", mid = "white", high = "green", midpoint = 0)


mapa <- propiedad |> 
  select(CPRO, AlquilerDifProv) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p2<- ggplot(esp_can) +
  geom_sf(color = "black", size = 0.7) +  
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = AlquilerDifProv), color = "black", size = 0.3) +  
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "white") +  
  geom_sf_text(data = mapa, aes(label = round(AlquilerDifProv, 1)), color = "black", size = 2.4, check_overlap = TRUE, nudge_y = -0.03, family = "Montserrat") + 
  theme_void() +  
  labs(title = "Difference of % of Young People in 'Rent' Residence Status in 2011 to 2021") +  
  theme(
    legend.position = "none",
    plot.title = element_text(family = "Calibri", size = 14),
    text = element_text(family = "Calibri")) + 
  coord_sf() +
  scale_fill_gradient2(low = "red", mid = "white", high = "green", midpoint = 0)

p1 <- p1 + theme(plot.margin = margin(0, 0, 0, -30))
p2 <- p2 + theme(plot.margin = margin(0, 0, 0, -30))


combined_plot <- ggarrange(p1, p2, ncol =1, nrow = 2)
combined_plot

ggsave("difpropiedadalquiler.png", plot = combined_plot, width = 6.5, height = 8, bg = "white")
```

### Evolución

```{r, fig.height=8, fig.width=8}

# Calcular las medias para cada régimen en 2011 y 2021
media_2011 <- propiedad %>%
  summarise(
    Property11 = mean(Propiedad11Mun, na.rm = TRUE),
    Rent11 = mean(Alquiler11Mun, na.rm = TRUE),
    Other11 = mean(Otro11Mun, na.rm = TRUE))

media_2021 <- propiedad %>%
  summarise(
    Property21 = mean(Propiedad21Mun, na.rm = TRUE),
    Rent21 = mean(Alquiler21Mun, na.rm = TRUE),
    Other21 = mean(Otro21Mun, na.rm = TRUE)
  )

# Combinar los datos en un solo dataframe
medias <- tibble(
  Year = c(2011, 2021),
  Property = c(media_2011$Property11, media_2021$Property21),
  Rent = c(media_2011$Rent11, media_2021$Rent21),
  Other = c(media_2011$Other11, media_2021$Other21)
)

# Transformar los datos a formato largo y modificar el orden de "Regime"
medias_long <- medias %>%
  pivot_longer(cols = c(Property, Rent, Other),
               names_to = "Regime",
               values_to = "Value") %>%
  mutate(Regime = factor(Regime, levels = c("Property", "Rent", "Other")))  # Modificar el orden de la variable "Regime" para la leyenda

# Crear el gráfico de líneas
ggplot(medias_long, aes(x = Year, y = Value, color = Regime, group = Regime)) +
  geom_line(size = 0.7) +
  geom_point(size = 2) +
  geom_text(aes(label = round(Value, 1)), vjust = -0.8, family = "Calibri", size = 4) +
  scale_color_manual(values=c("Property"="#ff7767", "Rent"="#19CF8B", "Other" = "#FFA500")) +  # Cambiar el color de "Otro"
  labs(title=NULL,  # Eliminar el título
       caption=NULL,  # Eliminar la leyenda
       x=NULL,
       y=NULL,
       color=NULL) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_x_continuous(breaks = c(2011, 2021), limits = c(2011, 2021)) +  # Establecer los límites y las marcas del eje x
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0, size = 24, family = "Calibri", color = "#333333"),  # Cambiar la fuente del título
    plot.caption = element_text(hjust = -0.1, vjust=-5, family = "Calibri", color="#C2C2C2"),  # Cambiar la fuente de la leyenda
    axis.title = element_blank(),
    axis.text.x = element_text(color="#333333", size = 9, family = "Calibri"),  # Cambiar la fuente del texto del eje x
    axis.text.y = element_text(color="#333333", size = 9, family = "Calibri"),  # Cambiar la fuente del texto del eje y
    axis.line.x = element_line(size = 0.5, color = "black"),
    axis.line.y = element_line(size = 0.5, color = "black"),
    legend.text = element_text(margin = margin(t = -3, r = 0, b = 0, l = -5), color="#333333", family = "Calibri"),  # Cambiar la fuente de la leyenda
    panel.background = element_rect(fill = "white", color = NA),  # Remove border
    panel.grid.major = element_line(color = "grey80", size = 0.5),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),  # Remove panel border
    plot.margin = unit(c(1, 0.5, 1.2, 1), "cm")) +
  guides(color = guide_legend(override.aes = list(shape = "square", size = 3, linetype = "blank")))


# Crear el gráfico de líneas
evo <- ggplot(medias_long, aes(x = Year, y = Value, color = Regime, group = Regime)) +
  geom_line(size = 0.7) +
  geom_point(size = 2, stroke = 0.5) +  # Ajustar el ancho de la línea de los puntos
  geom_text(aes(label = paste0(round(Value, 1), "%")), vjust = -0.8, family = "Calibri", size = 4.2, color = "black") +  # Agregar el signo de porcentaje y cambiar el color a negro
  scale_color_manual(values=c("Property"="#ff7767", "Rent"="#19CF8B", "Other" = "#FFA500")) +  # Cambiar el color de "Otro"
  labs(title=NULL,  # Eliminar el título
       caption=NULL,  # Eliminar la leyenda
       x=NULL,
       y=NULL,
       color=NULL) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_x_continuous(breaks = c(2011, 2021), limits = c(2011, 2021)) +  # Establecer los límites y las marcas del eje x
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0, size = 24, family = "Calibri", color = "#333333"),  # Cambiar la fuente del título
    plot.caption = element_text(hjust = -0.1, vjust=-5, family = "Calibri", color="#C2C2C2"),  # Cambiar la fuente de la leyenda
    axis.title = element_blank(),
    axis.text.x = element_text(color="#333333", size = 12, family = "Calibri"),  # Ajustar el tamaño de la fuente del texto del eje x
    axis.text.y = element_text(color="#333333", size = 12, family = "Calibri"),  # Ajustar el tamaño de la fuente del texto del eje y
    axis.line.x = element_line(size = 0.5, color = "black"),
    axis.line.y = element_line(size = 0.5, color = "black"),
    legend.text = element_text(margin = margin(t = -3, r = 0, b = 0, l = -5), color="#333333", family = "Calibri", size = 12),  # Ajustar el tamaño de la fuente de la leyenda
    panel.background = element_rect(fill = "white", color = NA),  # Remove border
    panel.grid.major = element_line(color = "grey80", size = 0.5),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),  # Remove panel border
    plot.margin = unit(c(1, 0.5, 1.2, 1), "cm")) +
  guides(color = guide_legend(override.aes = list(shape = "square", size = 3, linetype = "blank")))

ggsave("evolucion.png", plot = evo, width = 7, height = 5.5, bg = "white")

```

# Scatterplot

```{r}
municipios <- municipios |> 
    mutate(MUN_LITERAL = ifelse(grepl("\\d", MUN_LITERAL), paste(MUN_LITERAL, PROV_LITERAL), MUN_LITERAL))

names = municipios$MUN_LITERAL
prov = municipios$PROV_LITERAL
ccaa = municipios$CCAA

library(ggplot2)
scatterplot <- ggplot(municipios, aes(x = PropiedadDifMun, y = MUN_LITERAL,  color = CCAA)) +
  geom_point(aes(text = paste(MUN_LITERAL, "PropiedadDifMun:", PropiedadDifMun))) +
  geom_text(aes(label = MUN_LITERAL), hjust = 1.5, vjust = 0.5, size = 2.5) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(title = "Scatterplot Interactivo de Municipios",
       x = "PropiedadDifMun",
       y = "")

# Convertirlo en un gráfico interactivo con ggplotly
ggplotly(scatterplot, tooltip = "text")



```


# tonterias

```{r}

analisis <- municipios |> 
  select(MUN_LITERAL, PROV_LITERAL, PropiedadDifMun, AlquilerDifMun, OtroDifMun, PorcentajeTurísticas2021, ParoJuvenilDif, VaciasDif, PrecioAlquilerM2, RentaMedia2021) 


componente1 <- municipios |> 
  select(MUN_LITERAL, PROV_LITERAL, PropiedadDifMun, AlquilerDifMun, PrecioAlquilerM2, SecundariasDif, VaciasDif, Herencia11Mun) 


ft <- flextable(analisis)
ft <- autofit(ft)
save_as_image(x = ft, path = "C:/Users/alici/OneDrive/Documentos/Clase/Máster/Bcol/tabla.png")

compra11 <- read_xlsx("compra11.xlsx")
compra21 <- read_xlsx("compra21.xlsx")
municipios <- read_xlsx("municipios.xlsx")

analisis <- compra21 |> 
  select(MUN_LITERAL, PROV_LITERAL, PropiedadDifMun, AlquilerDifMun, OtroDifMun) |> 
  filter(PropiedadDifMun < -28) |> 
  arrange(PropiedadDifMun)
  
```

# descenso propiedad

```{r}

compra21 <-read_xlsx("compra21.xlsx")

```


