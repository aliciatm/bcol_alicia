---
title: "Untitled"
format: html
editor: visual
---

## Importar datos

```{r}
library(tidyverse)
library(ggpubr)
library(ggplot2)
library(patchwork)
library(readxl)
library(haven)


load("Microdatos2021/Personas/R/CensoPersonas_2021.RData")

microdatos2021 <- Microdatos
metadatos2021 <- Metadatos

microdatos2011 <- read_sav("Microdatos2011/Personas/poblacion_2011_v2.sav")

rm(Microdatos, Metadatos)
```

## Recodificaciones

```{r}

microdatos2021_rec <- microdatos2021 |> 
  mutate(
    HABITAT = case_when(
      CMUN %in% c(991, 992, 993) ~ "Rural",
      CMUN %in% c(666, 999) ~ NA,
      TRUE ~ "Urbano")) |> 
  mutate(
    TENEN_VIV = case_when(
      TENEN_VIV == 2 ~ "Propiedad",
      TENEN_VIV == 3 ~ "Alquiler",
      TENEN_VIV == 4 ~ "Otro")) |> 
  mutate(
    JOVEN = case_when(
      VAREDAD >= 18 & VAREDAD < 35 ~ "Joven",
      VAREDAD >= 35 ~ "Adulto",
      VAREDAD < 18 ~ "Niño",
      TRUE ~ NA))

## Filtrar microdatos

jovenes <- microdatos2021_rec |> 
  select(CPRO, CMUN, VAREDAD, TENEN_VIV, HABITAT, JOVEN) |>
      mutate(  
    CPRO = trimws(CPRO),
    CMUN = trimws(CMUN),
    cusec = paste0(CPRO, CMUN)) |> 
  filter(JOVEN == "Joven")

rm(metadatos2021)
```

### CCAA

```{r}

# Añadir CCAA 
ccaas <- data.frame(
  CodigoProvincia = c("01", "02", "03", "04", "33", "05", "06", "08", "09", "10", "11", "39", "12", "13", "14", "16", "17", "18", "19", "20", "21", "22", "23", "07", "24", "15", "35", "25", "26", "27", "28", "29", "30", "31", "32", "34", "36", "37",
"38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49", "50", "51", "52"),
  
  CCAA = c("País Vasco", "Castilla-La Mancha", "Comunidad Valenciana", "Andalucía", "Asturias", "Castilla y León", "Extremadura", "Cataluña", "Castilla y León", "Extremadura", "Andalucía", "Cantabria", "Comunidad Valenciana", "Castilla-La Mancha", "Andalucía", "Castilla-La Mancha", "Cataluña", "Andalucía", "Castilla-La Mancha", "País Vasco", "Andalucía", "Aragón", "Andalucía", "Islas Baleares", "Castilla y León", "Galicia", "Canarias", "Cataluña", "La Rioja", "Galicia", "Comunidad de Madrid", "Andalucía", "Comunidad de Murcia", "Comunidad Foral de Navarra", "Galicia", "Castilla y León", "Galicia", "Castilla y León", "Canarias", "Cantabria", "Castilla y León", "Andalucía", "Castilla y León", "Cataluña", "Aragón", "Castilla-La Mancha", "Comunidad Valenciana", "Castilla y León", "País Vasco", "Castilla y León", "Aragón", "Ceuta", "Melilla"))


jovenes <- jovenes |> 
  left_join(ccaas, by = c("CPRO" = "CodigoProvincia"))

```

## Probabilidad compra/alquiler/otros de jóvenes en 2021

```{r}

jovenes <- jovenes |> 
  select(-VAREDAD)

# Por municipio
jovenes <- jovenes |> 
  group_by(cusec) |> 
  mutate(
    Propiedad21Mun = round((sum(TENEN_VIV == "Propiedad") / n()) * 100, 2),
    Alquiler21Mun = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro21Mun = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2))

# Por provincia

jovenes <- jovenes |> 
  group_by(CPRO) |> 
  mutate(
    Propiedad21Prov = round((sum(TENEN_VIV == "Propiedad") / n()) * 100, 2),
    Alquiler21Prov = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro21Prov = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2))

# Por CCAA

jovenes <- jovenes |> 
  group_by(CCAA) |> 
  mutate(
    Propiedad21CCAA = round((sum(TENEN_VIV == "Propiedad") / n()) * 100, 2),
    Alquiler21CCAA = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro21CCAA = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2))


# Por municipios rurales
# Esto hace que desaparezcan CPRO 51 y 52
#jovenes <- jovenes |> 
#  filter(HABITAT == "Rural") |> 
#  mutate(
#    Propiedad21Rural = round((sum(HABITAT == "Rural") / n()) * 100, 2),
#    Alquiler21Rural = round((sum(HABITAT == "Rural") / n()) * 100, 2),
#    Otro21Rural = round((sum(HABITAT == "Rural") / n()) * 100, 2))


```

Ahora reordenamos y eliminamos algunas variables

```{r}

jovenes <- jovenes |> 
  select(cusec, CCAA, CPRO, CMUN,  HABITAT, Propiedad21Mun, Alquiler21Mun, Otro21Mun, Propiedad21Prov, Alquiler21Prov, Otro21Prov, Propiedad21CCAA, Alquiler21CCAA, Otro21CCAA)

```

## Microdatos 2011

```{r}

variables <- c("CPRO", "CMUN", "EDAD", "TENEN")

microdatos2011_limpio <- microdatos2011 |> 
    select(all_of(variables))
  

 jovenes11 <- microdatos2011_limpio |> 
  mutate(
     HABITAT = case_when(
       CMUN %in% c(991, 992, 993, 994) ~ "Rural",
       TRUE ~ "Urbano"))|> 
  mutate(
    TENEN_r = case_when(
      TENEN == 1 ~ "Propiedad",
      TENEN == 2 ~ "Hipoteca",
      TENEN == 3 ~ "Herencia o donación",
      TENEN == 4 ~ "Alquiler",
      TENEN == 5 ~ "Cedida o a bajo precio",
      TENEN == 6 ~ "Otro")) |> 
   mutate(
     TENEN_VIV = case_when(
       TENEN_r %in% c("Propiedad", "Hipoteca", "Herencia o donación") ~ "Propiedad",
       TENEN_r == "Alquiler" ~ "Alquiler",
       TENEN_r %in% c("Cedida o a bajo precio", "Otro") ~ "Otro")) |> 
    mutate(
    JOVEN = case_when(
      EDAD >= 18 & EDAD < 35 ~ "Joven",
      EDAD >= 35 ~ "Adulto",
      EDAD < 18 ~ "Niño",
      TRUE ~ NA )) |> 
   mutate(
    CMUN = str_pad(CMUN, width = 3, side = "left", pad = "0"),
    CPRO = str_pad(CPRO, width = 2, side = "left", pad = "0")) |> 
    mutate(  
    CPRO = trimws(CPRO), #Esto para que no quede espacio tras usar paste
    CMUN = trimws(CMUN),
    cusec = paste0(CPRO, CMUN)) |> 
   filter(JOVEN == "Joven")
 
# Se añaden las CCAA 
jovenes11 <- jovenes11 |> 
  left_join(ccaas, by = c("CPRO" = "CodigoProvincia"))
```

## Probabilidad compra/alquiler/otros de jóvenes en 2011

```{r}

# Por municipio
jovenes11 <- jovenes11 |> 
  group_by(cusec) |> 
  mutate(
    Propiedad11Mun = round((sum(TENEN_VIV == "Propiedad") / n()) * 100, 2),
    Alquiler11Mun = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro11Mun = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2))

# Por provincia
jovenes11 <- jovenes11 |> 
  group_by(CPRO) |> 
  mutate(
    Propiedad11Prov = round((sum(TENEN_VIV == "Propiedad") / n()) * 100, 2),
    Alquiler11Prov = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro11Prov = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2))

# Por CCAA
jovenes11 <- jovenes11 |> 
  group_by(CCAA) |> 
  mutate(
    Propiedad11CCAA = round((sum(TENEN_VIV == "Propiedad") / n()) * 100, 2),
    Alquiler11CCAA = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro11CCAA = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2))


```

## Nombres lugares

```{r}
# Importar base de datos de vivienda turística porque incluye estos nombres
# Hay que poner eso de NA porque sino sale un warning muy largo
locations <- read_excel("vivienda turística/exp_viv_turistica_tabla5_FEB2021.xlsx", sheet = 3, na = "Dato protegido por secreto estadístico.")

nombres_municipios <- locations |> 
  select(MUN_LITERAL, MUN) |> 
  rename(cusec = MUN) |> 
  distinct(cusec, .keep_all = TRUE)

nombres_provincias <- locations |> 
  select(PROV_LITERAL, PROV) |> 
  rename(CPRO = PROV) |> 
  distinct(CPRO, .keep_all = TRUE)

```

## Unir ambas tablas con todas las columnas interesantes

Una sola row por cada municipio (cusec). En 2011 'censura' el código de identificación de los municipios de 10000 a 20000 habitantes, mientras que en 2021 sólo de los menores de 10000. Al juntar ambas datasets 'se pierde' la identificación de esos municipios de 10 a 20 mil. Pero son muy pocos y no creo que sea muy relevante; de todas formas se podría discernir cuáles son porque también aparece de qué provincia son.

```{r}
# Añadir nombres municipios y provincias
jovenes_total <- jovenes |> 
  left_join(nombres_municipios, by = "cusec", "cusec") |> 
  left_join(nombres_provincias, by = "CPRO", "CPRO") |> 
  distinct(cusec, .keep_all = TRUE)


# Añadir datos 2011
# Tiene menos municipios (porque los de 10k a 20k no los especifica)
jovenes_total <- jovenes11 |>
  distinct(cusec, .keep_all = TRUE) |> 
  select(cusec, CCAA, Propiedad11Mun, Alquiler11Mun, Otro11Mun, Propiedad11Prov, Alquiler11Prov, Otro11Prov, Propiedad11CCAA, Alquiler11CCAA, Otro11CCAA) |> 
  left_join(jovenes_total, by = "cusec", "cusec")


#Ordenar
# Al juntarlos se eliminan los municipios que sí salen en 2021
jovenes_total <- jovenes_total |> 
  select(cusec, CCAA.x, CPRO, PROV_LITERAL, CMUN, MUN_LITERAL, HABITAT, Propiedad21Mun, Alquiler21Mun, Otro21Mun, Propiedad11Mun, Alquiler11Mun, Otro11Mun, Propiedad21Prov, Alquiler21Prov, Otro21Prov, Propiedad11Prov, Alquiler11Prov, Otro11Prov, Propiedad21CCAA, Alquiler21CCAA, Otro21CCAA, Propiedad11CCAA, Alquiler11CCAA, Otro11CCAA) |> 
  filter(str_sub(cusec, -3) != "994") 
```

## Diferencia 2011 y 2021

### Por municipio

```{r}

# Propiedad
jovenes_total <- jovenes_total |> 
  mutate(
    PropiedadDifMun = Propiedad21Mun - Propiedad11Mun)

# Alquiler
jovenes_total <- jovenes_total |> 
  mutate(
    AlquilerDifMun = Alquiler21Mun - Alquiler11Mun)

# Otro
jovenes_total <- jovenes_total |> 
  mutate(
    OtroDifProv = Otro21Mun - Otro11Mun)


```

### Por provincia

```{r}
# Propiedad

jovenes_total <- jovenes_total |> 
  mutate(
    PropiedadDifProv = Propiedad21Prov - Propiedad11Prov)

# Alquiler
jovenes_total <- jovenes_total |> 
  mutate(
    AlquilerDifProv = Alquiler21Prov - Alquiler11Prov)

# Otro
jovenes_total <- jovenes_total |> 
  mutate(
    OtroDifProv = Otro21Prov - Otro11Prov)

```

## Mapas

### Mapa por mun

```{r}
library(mapSpain)
  
esp_can <- esp_get_country() 
can_prov <- esp_get_can_provinces()
can_box <- esp_get_can_box() 
munic <- esp_get_munic() 

munic <-    
  munic |>  
  mutate(cusec = cmun) |> 
  select(geometry, cusec)


# Mapa por municipios
# PROPIEDAD

mapa <- jovenes_total |> 
  select(CCAA.x, cusec, Propiedad21Mun)
  
mapa <- munic |> 
  left_join(mapa, by = "cusec")
  
mapa_mun <- ggplot(esp_can) +
    geom_sf() +
    geom_sf(data = can_prov) +
    geom_sf(data = can_box) + 
    geom_sf(data = mapa, aes(fill = Propiedad21Mun), color = "black", size = 1) + 
    theme_void() +  
    labs(title = "Probabilidad de compra por municipio") +  
    theme(legend.position = c(0.18, 0.55),    
          legend.justification = "center",   
          legend.background = element_rect(fill = NULL, colour = "black"),
          legend.margin = margin(6, 6, 6, 6))+ 
    guides(fill = guide_legend(ncol = 2)) + 
    coord_sf()

mapa_mun

#ALQUILER

mapa <- jovenes_total |> 
  select(CCAA.x, cusec, Alquiler21Mun)
  
mapa <- munic |> 
  left_join(mapa, by = "cusec")
  
mapa_mun <- ggplot(esp_can) +
    geom_sf() +
    geom_sf(data = can_prov) +
    geom_sf(data = can_box) + 
    geom_sf(data = mapa, aes(fill = Alquiler21Mun), color = "black", size = 1) + 
  theme_void() +  
  labs(title = "Probabilidad de alquiler por provincia") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6))+ 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf()

mapa_mun


```

### Mapa por provincias

```{r, fig.height=6, fig.width=12}
# Propiedad 2021
provic <- esp_get_prov() |> 
  mutate(CPRO = cpro)

mapa <- jovenes_total |> 
  select(CPRO, Propiedad21Prov)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

mapa_prop_prov21 <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Propiedad21Prov), color = "black", size = 1) + 
        geom_sf_text(data = mapa, aes(label = round(Propiedad21Prov, 1)), color = "black", size = 2.5, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas
  theme_void() +  
  labs(title = "Probabilidad de propiedad por provincia 2021") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1, limits = c(55, 85))


# Propiedad 2011
provic <- esp_get_prov() |> 
  mutate(CPRO = cpro)

mapa <- jovenes_total |> 
  select(CPRO, Propiedad11Prov)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

mapa_prop_prov11 <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Propiedad11Prov), color = "black", size = 1) + 
        geom_sf_text(data = mapa, aes(label = round(Propiedad11Prov, 1)), color = "black", size = 2.5, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas

  theme_void() +  
  labs(title = "Probabilidad de propiedad por provincia 2011") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1, limits = c(55, 85))

# Alquiler

provic <- esp_get_prov() |> 
  mutate(CPRO = cpro)

mapa <- jovenes_total |> 
  select(CPRO, Alquiler21Prov)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

mapa_alq_prov21 <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Alquiler21Prov), color = "black", size = 1) + 
        geom_sf_text(data = mapa, aes(label = round(Alquiler21Prov, 1)), color = "black", size = 2.5, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas

  theme_void() +  
  labs(title = "Probabilidad de alquiler por provincia") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1, limits = c(4, 34))


# Alquiler 2011

provic <- esp_get_prov() |> 
  mutate(CPRO = cpro)

mapa <- jovenes_total |> 
  select(CPRO, Alquiler11Prov)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

mapa_alq_prov11 <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Alquiler11Prov), color = "black", size = 1) + 
  geom_sf_text(data = mapa, aes(label = round(Alquiler11Prov, 1)), color = "black", size = 2.5, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas
  theme_void() +  
  labs(title = "Probabilidad de alquiler por provincia 2011") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1, limits = c(4, 34))

ggarrange(mapa_prop_prov21, mapa_prop_prov11, mapa_alq_prov21, mapa_alq_prov11,
          nrow=2, ncol=2)

```

### Variación por provincia de 2011 a 2021

```{r, fig.height=6, fig.width=12}
# Mapa por provincias PROPIEDAD

provic <- esp_get_prov() |> 
  mutate(CPRO = cpro)

mapa <- jovenes_total |> 
  select(CPRO, PropiedadDifProv)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")
  
mapa_propiedad_prov <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = PropiedadDifProv), color = "black", size = 1) + 
    geom_sf_text(data = mapa, aes(label = round(PropiedadDifProv, 1)), color = "black", size = 3, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas
  theme_void() +  
  labs(title = "Probabilidad de compra por provincia") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6))+ 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_gradient2(low = "red", mid = "white", high = "green", midpoint = 0, limits = c(-16, 5))

# ALQUILER


provic <- esp_get_prov() |> 
  mutate(CPRO = cpro)

mapa <- jovenes_total |> 
  select(CPRO, AlquilerDifProv)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")
  
mapa_alquiler_prov <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = AlquilerDifProv), color = "black", size = 1) + 
  geom_sf_text(data = mapa, aes(label = round(AlquilerDifProv, 1)), color = "black", size = 3, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas
  theme_void() +  
  labs(title = "Probabilidad de alquiler por provincia") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_gradient2(low = "red", mid = "white", high = "green", midpoint = 0, limits = c(-2, 17))


# OTRO

provic <- esp_get_prov() |> 
  mutate(CPRO = cpro)

mapa <- jovenes_total |> 
  select(CPRO, OtroDifProv)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")
  
mapa_otro_prov <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = OtroDifProv), color = "black", size = 1) + 
    geom_sf_text(data = mapa, aes(label = round(OtroDifProv, 1)), color = "black", size = 3, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas

  theme_void() +  
  labs(title = "Probabilidad de otro por provincia") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6))+ 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_gradient2(low = "red", mid = "white", high = "green", midpoint = 0, limits = c(-5, 5))

ggarrange(mapa_propiedad_prov, mapa_alquiler_prov, mapa_otro_prov,
          ncol = 2, nrow = 2)

```

## Ver top CCAA con mas propiedad y alquiler en 2021 y 2011

```{r, fig.height=6, fig.width=12}
# Top CCAA con más propiedad en 2021
top_propiedad_2021 <- jovenes_total %>%
  arrange(desc(Propiedad21CCAA)) %>%
  distinct(Propiedad21CCAA, .keep_all = TRUE) |> 
  select(Propiedad21CCAA, CCAA.x)

top_propiedad_2021

# Top CCAA con más alquiler en 2021
top_alquiler_2021 <- jovenes_total %>%
  arrange(desc(Alquiler21CCAA)) %>%
    distinct(Alquiler21CCAA, .keep_all = TRUE) |> 
    select(Alquiler21CCAA, CCAA.x)

top_alquiler_2021

# Top CCAA con más propiedad en 2011
top_propiedad_2011 <- jovenes_total %>%
  arrange(desc(Propiedad11CCAA)) %>%
    distinct(Propiedad11CCAA, .keep_all = TRUE) |> 
    select(Propiedad11CCAA, CCAA.x)

top_propiedad_2011

# Top CCCAA con más alquiler en 2011
top_alquiler_2011 <- jovenes_total %>%
    distinct(Alquiler11CCAA, .keep_all = TRUE) |> 
  arrange(desc(Alquiler11CCAA)) %>%
    select(Alquiler11CCAA, CCAA.x)


top_propiedad_2021
top_propiedad_2011
top_alquiler_2021
top_alquiler_2011


# Visualizar las cuatro tablas en cuatro gráficos de barras horizontales
plot_propiedad_2021 <- ggplot(jovenes_total, aes(x = reorder(CCAA.x, Propiedad21CCAA), y = Propiedad21CCAA)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(title = "Top CCAA con más propiedad en 2021", x = "CCAA", y = "Proporción de propiedad") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

plot_alquiler_2021 <- ggplot(jovenes_total, aes(x = reorder(CCAA.x, Alquiler21CCAA), y = Alquiler21CCAA)) +
  geom_bar(stat = "identity", fill = "salmon") +
  labs(title = "Top CCAA con más alquiler en 2021", x = "CCAA", y = "Proporción de alquiler") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

plot_propiedad_2011 <- ggplot(jovenes_total, aes(x = reorder(CCAA.x, Propiedad11CCAA), y = Propiedad11CCAA)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(title = "Top CCAA con más propiedad en 2011", x = "CCAA", y = "Proporción de propiedad") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

plot_alquiler_2011 <- ggplot(jovenes_total, aes(x = reorder(CCAA.x, Alquiler11CCAA), y = Alquiler11CCAA)) +
  geom_bar(stat = "identity", fill = "salmon") +
  labs(title = "Top CCAA con más alquiler en 2011", x = "CCAA", y = "Proporción de alquiler") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Mostrar los gráficos
ggarrange(plot_propiedad_2021, plot_alquiler_2021, plot_propiedad_2011, plot_alquiler_2011, nrow = 2, ncol = 2)


```

Las CCAA con más propiedad entre jóvenes en 2011 son País Vasco (83,12%), Comunidad Valenciana, Navarra, Murcia y Andalucía. Sin embargo, en 2021 éstas son Andalucía con un máximo de 77.31%, seguido de Extremadura, Castilla-La Mancha, Castilla y León y Comunidad de Murcia.

Esto muestra que ha habido un descenso generalizado de la propiedad en toda España, pero éste no ha sido homogéneo. Andalucía, por ejemplo, sólo pierde un 4%; mientras que País Vasco experimenta un descenso del 12%.

Con respecto a los valores más bajos de propiedad en 2011, éstos eran CCAA pequeñas como las islas y Ceuta y Melilla, así como Cataluña y Madrid. Esta tendencia sí se mantiene en 2021, salvo Ceuta, que pasa a tener más porcentaje de propiedad y sale de las CCAA más bajas.

Alquiler. El alquiler sobresalía en 2011 en las CCAA de Melilla, Baleares, Cataluña, Madrid. En 2021, si bien Melilla sigue encabezando la lista, ha entrado entre las CCAA con mayor alquiler País Vasco, que parece ser el caso más dramático, Aragón o Comunitat Valenciana Además, en las CCAA con poca proproción de alquiler, éste ha aumentado pero poco; y cuanto más alquiler en 2011, más ha aumentado para 2021. T

### Provincias

```{r}

# Top provincias con más propiedad en 2021
top_propiedad_2021 <- jovenes_total %>%
  arrange(desc(Propiedad21Prov)) %>%
  distinct(Propiedad21Prov, .keep_all = TRUE) |> 
  select(Propiedad21Prov, PROV_LITERAL)

top_propiedad_2021

# Top CCAA con más alquiler en 2021
top_alquiler_2021 <- jovenes_total %>%
  arrange(desc(Alquiler21Prov)) %>%
    distinct(Alquiler21Prov, .keep_all = TRUE) |> 
    select(Alquiler21Prov, PROV_LITERAL)

top_alquiler_2021

# Top CCAA con más propiedad en 2011
top_propiedad_2011 <- jovenes_total %>%
  arrange(desc(Propiedad11Prov)) %>%
    distinct(Propiedad11Prov, .keep_all = TRUE) |> 
    select(Propiedad11Prov, PROV_LITERAL)

top_propiedad_2011

# Top CCCAA con más alquiler en 2011
top_alquiler_2011 <- jovenes_total %>%
    distinct(Alquiler11Prov, .keep_all = TRUE) |> 
  arrange(desc(Alquiler11Prov)) %>%
    select(Alquiler11Prov, PROV_LITERAL)


top_propiedad_2021
top_propiedad_2011
top_alquiler_2021
top_alquiler_2011


```

Provincias como Barcelona han perdido un 15% de propiedad, así como Álava y en general la Comunitat Valenciana, como veíamos antes.

A primera vista, no parece que la proporción de vivienda turística explique totalmente la menor propiedad. Algunos casos como el de la Comunitat Valenciana, las islas o Cataluña (especialmente Barcelona) podrían relacionarse con esto. Pero en casos como la provincia de Málaga que tiene una cantidad enorme de vivienda turística, no se ve este descenso de propiedad; o en casos como el País Vasco y Zaragoza, hay gran descenso de propiedad pero no hay mucho turismo.

Las únicas provincias con más propiedad en 2021 que en 2011 son Jaén, Cáceres y Teruel, aunque con una variación muy pequeña. Son ciudades con menos población joven (y población en general).

### Por municipios

```{r}

top_dif_propiedad <- jovenes_total %>%
    distinct(PropiedadDifMun, .keep_all = TRUE) |> 
  arrange(desc(PropiedadDifMun)) %>%
    select(PropiedadDifMun, CCAA.x, PROV_LITERAL, MUN_LITERAL, CMUN)

```

Hay municipios donde sí están comprando más los jóvenes que en 2011, contrariando la tendencia general. Con un máximo de +9%, encontramos Úbeda, un municipio grande en Jaén. Seguido de Nerja en Málaga, Conil de la Frontera, Ronda, Écija, Carmona... También encontramos a Ceuta. Son municipios andaluces que no son las capitales de provincia pero son significativos, ofrecen puestos de trabajo, incluso una universidad en Carmona. Son municipios cercanos a la capital y donde es frecuente que la gente viaje todos los días a ella para trabajar. Podríamos ver por tanto que son municipios en las áreas metropolitanas. Se podría comprobar si ésto se produce por motivos laborales viendo la situación laboral.

Por otra parte, vemos municipios cuyo nombre desconocemos al tener menos de 20000 habitantes, pertenecientes de nuevo a Andalucía o a Castilla y León, Galicia...

Por otro lado, los municipios donde ahora residen menos los jóvenes en propiedad son de Cataluña, Comunitat Valenciana o País Vasco. Podría analizarse si en Comunitat Valenciana por ejempo se produce más en municipios con más vivienda turística (ej. Benidorm aparece con -17%).

Este aumento es mayor que en el grupo de 'adultos', y no coinciden todos los municipios. El aumento de alquiler en País Vasco, además, es mucho más notable entre jóvenes.

# Propiedad por compra de jóvenes en 2011

Un 38.59% de los jóvenes en 2011 tenían un régimen de vivienda de 'hipoteca', siendo el régimen de tenencia más frecuente seguido de 'propiedad'. Sólo un 12.87% vivían de alquiler. La edad media de los jóvenes con hipoteca era un año superior a la población joven general.

```{r}

ggplot(jovenes11,mapping=aes(x=TENEN_r, fill = TENEN_r))+geom_bar(aes(y=..count../sum(..count..)))

(sum(jovenes11$TENEN_r == "Hipoteca") / nrow(jovenes11)) * 100
(sum(jovenes11$TENEN_r == "Alquiler") / nrow(jovenes11)) * 100

hipotecados <- jovenes11 |> 
  filter(TENEN_r == "Hipoteca")

# Edad media
mean(jovenes11$EDAD)
mean(hipotecados$EDAD)


# Por municipio
jovenes11 <- jovenes11 |> 
  group_by(cusec) |> 
  mutate(
    Hipoteca11Mun = round((sum(TENEN_r == "Hipoteca") / n()) * 100, 2))

hipotecas <- jovenes11 |> 
  select(cusec,Hipoteca11Mun) |> 
  distinct(cusec, .keep_all = TRUE)

jovenes_total <- jovenes_total |> 
  left_join(hipotecas, by = "cusec")


jovenes_total |> 
  arrange(desc(Hipoteca11Mun)) %>%
  distinct(cusec, .keep_all = TRUE) |> 
  select(PROV_LITERAL, MUN_LITERAL, Hipoteca11Mun)

```

# -

# Paquetes y ccaas

```{r}

library(tidyverse)
library(ggpubr)
library(ggplot2)
library(patchwork)
library(readxl)
library(haven)


# Añadir CCAA 
ccaas <- data.frame(
  CodigoProvincia = c("01", "02", "03", "04", "33", "05", "06", "08", "09", "10", "11", "39", "12", "13", "14", "16", "17", "18", "19", "20", "21", "22", "23", "07", "24", "15", "35", "25", "26", "27", "28", "29", "30", "31", "32", "34", "36", "37",
"38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49", "50", "51", "52"),
  
  CCAA = c("País Vasco", "Castilla-La Mancha", "Comunidad Valenciana", "Andalucía", "Asturias", "Castilla y León", "Extremadura", "Cataluña", "Castilla y León", "Extremadura", "Andalucía", "Cantabria", "Comunidad Valenciana", "Castilla-La Mancha", "Andalucía", "Castilla-La Mancha", "Cataluña", "Andalucía", "Castilla-La Mancha", "País Vasco", "Andalucía", "Aragón", "Andalucía", "Islas Baleares", "Castilla y León", "Galicia", "Canarias", "Cataluña", "La Rioja", "Galicia", "Comunidad de Madrid", "Andalucía", "Comunidad de Murcia", "Comunidad Foral de Navarra", "Galicia", "Castilla y León", "Galicia", "Castilla y León", "Canarias", "Cantabria", "Castilla y León", "Andalucía", "Castilla y León", "Cataluña", "Aragón", "Castilla-La Mancha", "Comunidad Valenciana", "Castilla y León", "País Vasco", "Castilla y León", "Aragón", "Ceuta", "Melilla"))


```

# Definiendo a los jóvenes que compran

https://www.ine.es/prensa/ecepov_2021_feb.pdf

### En 2011

```{r}

compra11 <- microdatos2011 |> 
  select(CPRO, CMUN, EDAD, SEXO, ANAC, NORDEN, ANORES, ANOM, LTRABA, MUNTRABA, TENEN, CON_NORDEN, OPA_NORDEN, TIPOPER, ESTHOG, EDADPAD, EDADMAD) 

compra11 <- compra11 |> 
  filter(EDAD %in% c(18:35), # Jóvenes
         TIPOPER != "H", # Que no son hijos en el núcleo
         is.na(EDADPAD), # Que no conviven con el padre
         is.na(EDADMAD)) |> # Que no conviven con la madre 
    select(-EDADPAD, -EDADMAD) |> 
  filter(ESTHOG %in% c(01, 02, 05, 07, 08, 10, 11)) # No es un hogar con una persona sola de +65 años ni hijos de más de 25

compra11 <- compra11 |> 
  mutate(mayor = ifelse(ANORES - ANAC > 18, TRUE, FALSE)) |> 
  filter(mayor == TRUE) # Que era mayor de edad en la última mudanza

compra11 <- compra11 |> 
  filter(NORDEN %in% c(1, 2)) |># Que es 1 o 2 en el núcleo
  filter(!(OPA_NORDEN %in% c(1))) # Que otro pariente no es 1


#Recodificar tenen viv
compra11 <- compra11 |>  
  mutate(
    TENEN_r = case_when(
      TENEN == 1 ~ "Propiedad por compra, pagada",
      TENEN == 2 ~ "Propiedad por compra, pagos pendientes",
      TENEN == 3 ~ "Propiedad por herencia o donación",
      TENEN == 4 ~ "Alquiler",
      TENEN == 5 ~ "Cedida o a bajo precio",
      TENEN == 6 ~ "Otro")) |> 
  mutate(
    TENEN_VIV = case_when(
      TENEN_r %in% c("Propiedad por compra, pagada", "Propiedad por compra, pagos pendientes") ~ "Compra",
      TENEN_r == "Propiedad por herencia o donación" ~ "Herencia o donación",
      TENEN_r == "Alquiler" ~ "Alquiler",
      TENEN_r %in% c("Cedida o a bajo precio", "Otro") ~ "Otro"))

```

Añadir nombres municipios/provincias

```{r}

# Crear los códigos cusec de los municipios no especificados
cusec_991 <- sprintf("%05d", seq(1991, 52991, by = 1000))
cusec_992 <- sprintf("%05d", seq(1992, 52992, by = 1000))
cusec_993 <- sprintf("%05d", seq(1993, 52993, by = 1000))
cusec_994 <- sprintf("%05d", seq(1994, 52994, by = 1000))
cusec <- c(cusec_991, cusec_992, cusec_993, cusec_994)

MUN_LITERAL <- 
  ifelse(substr(cusec, 4, 5) == "91","<=2000",
  ifelse(substr(cusec, 4, 5) == "92", "2001 <= 5000",
  ifelse(substr(cusec, 4, 5) == "93", "5001 <= 10000",
  ifelse(substr(cusec, 4, 5) == "94", "10001 <= 20000","Otros"))))

df_rural <- data.frame(MUN_LITERAL, cusec)
  
nombres_municipios <- rbind(nombres_municipios, df_rural)
  
#Añado id para evitar duplicados
compra11 <- compra11 |> 
  mutate(id = row_number())


# Añadir nombres de provincias y municipios
compra11 <- compra11 |> 
  mutate(
    CMUN = str_pad(CMUN, width = 3, side = "left", pad = "0"),
    CPRO = str_pad(CPRO, width = 2, side = "left", pad = "0")) |> 
   mutate(  
    CPRO = trimws(CPRO),
    CMUN = trimws(CMUN),
    cusec = paste0(CPRO, CMUN)) |> 
  
  left_join(nombres_municipios, by = "cusec") |> 
  left_join(nombres_provincias, by = "CPRO") |> 
  left_join(ccaas, by = c("CPRO" = "CodigoProvincia")) |> 

  distinct(id, .keep_all = T)


compra11_r <- compra11 |> 
  filter(TENEN_r %in% c("Propiedad por compra, pagada", "Propiedad por compra, pagos pendientes"))
  
```

### En 2021

Hay limitaciones, porque no puedo retirar exactamente que NO sean herencia.

```{r}

compra21 <- microdatos2021 |> 
  select(CPRO, CMUN, VAREDAD, SEXO, ANAC, TENEN_VIV, NORDEN, RESI_NACIM, VARANORES, VARANOM, CMUN_ANT, CMUN_UNANO, RESI_UNANO, CMUN_DANO, RESI_DANO, LTRAB, CMUN_TRAB, LEST, CMUN_EST, NORDEN_CON, NORDEN_OPA, TIPOPER, SEXO_MAD, SEXO_PAD, ESTRUC_HOG) 

compra21 <- compra21 |> 
  filter(VAREDAD %in% c(18:35), # Jóvenes
         TIPOPER != "H", # Que no son hijos en el núcleo
         SEXO_PAD == "N", # Que no conviven con el padre
         SEXO_MAD == "N") |>  # Que no conviven con la madre
  mutate(ESTRUC_HOG = as.numeric(ESTRUC_HOG)) |> 
  filter(ESTRUC_HOG %in% c(01, 02, 05, 07, 08, 10, 11)) # No es un hogar con una persona sola de +65 años ni hijos de más de 25

# Filtrar para haberse mudado a otra vivienda con mínimo 18 años, en una forma amplia

compra21 <- compra21 |> 
  mutate(
    VARANORES_r = case_when(
      VARANORES == "0005" ~ as.numeric(2015),
      VARANORES == "0004" ~ as.numeric(2010),
      VARANORES %in% c("9999", "0003") ~ as.numeric(2000), 
      VARANORES == " " ~ NA,
      TRUE ~ as.numeric(VARANORES)),
      ANAC = as.numeric(ANAC),
      mayor = ifelse(VARANORES_r - ANAC > 18, TRUE, FALSE)) |> 
  filter(mayor == TRUE)

compra21 <- compra21 |>
  filter(NORDEN %in% c("01", "02")) |> # Que es orden 1 o 2 en el núcleo
  filter(!(NORDEN_OPA %in% c("01")))

# Recodificar rég tenencia
compra21 <- compra21 |> 
    mutate(
    TENEN_VIV = case_when(
      TENEN_VIV == 2 ~ "Propiedad",
      TENEN_VIV == 3 ~ "Alquiler",
      TENEN_VIV == 4 ~ "Otro")) 



```

Añadir nombres

```{r}

#Añado id para evitar duplicados
compra21 <- compra21 |> 
  mutate(id = row_number())


compra21 <- compra21 |> 
  mutate(
    CMUN = str_pad(CMUN, width = 3, side = "left", pad = "0"),
    CPRO = str_pad(CPRO, width = 2, side = "left", pad = "0")) |> 
   mutate(  
    CPRO = trimws(CPRO),
    CMUN = trimws(CMUN),
    cusec = paste0(CPRO, CMUN)) |> 
  
  left_join(nombres_municipios, by = "cusec") |> 
  left_join(nombres_provincias, by = "CPRO") |> 
  left_join(ccaas, by = c("CPRO" = "CodigoProvincia")) |> 

  distinct(id, .keep_all = T)


compra21_r <- compra21 |> 
  filter(TENEN_VIV == "Propiedad")

```

## Descriptivo

### 2011

Hay menos jóvenes con las condiciones especificadas en 2021 que en 2011. Hay 15% del total en 2021, y 26% del total en 2011 (descenso del 35%).

-   Edad. La media de edad en 2011 es de 31,4, en 2021 es de 31,16.

-   Número de orden en el núcleo. La mitad de los casos tienen a la persona encuestada como primera persona en el orden del núcleo, con un 42,8% restante siendo la segunda persona. Le siguen un 4,1% siendo la tercera persona, un 2,3% la cuarta, 1% la quinta, y porecentajes desdeñables el resto. Hay una persona que es la persona número 24. Vemos exactamente quiénes son estas personas: personas con un 50% de desempleo (25% superior al resto). Residiendo en Ceuta, Melilla. Son 941 personas.

-   Orden de un pariente. Quitar personas que su otro pariente tiene un orden superior (1). La mayoría de casos los parientes son el número 3, con 78,9%. (pueden ser hijos, por ejemplo. En un 10% el otro pariente es número 2. En un 47,5% de los casos no hay familiares.

-   Trabajo. La mayoría de personas trabajan en un municipio distinto al que residen (4, 45,9%), seguido de personas que trabajan en el mismo municipio (3, 36,6%).

-   Año de llegada a la vivienda. En la mayoría de los casos se llegó en 2006 o 2007 (es también la media). Sería una edad media de 25-26 años.

-   Condición dentro del núcleo. Un 80.6% de las personas son cónyuges, un 16% personas que viven solas y el resto madres y padres solteros.

-   Estructura del hogar. La mayoría de los casos, 46,2%, es un hogar formado por una pareja con hijos. En segundo lugar, 32,3%, hogar formado por pareja sin hijos. En tercer lugar, con 3,2%, 'otro tipo de hogar', que puede ser compañeros de piso no emparentados, o otros familiares. El último es padre o madre soltera.

-   Tipo de compra. En el 92,6% de los casos quedan pagos de la hipoteca pendientes.

-   Provincia. No da mucha información porque salen las provincias más y menos pobladas, no proporcionalmente según su población.

```{r}
# Edad
mean(compra11_r$EDAD)
round(prop.table(table(compra11_r$EDAD)), digits = 3)
hist(compra11_r$EDAD)

# Número de orden
round(prop.table(table(compra11_r$NORDEN)), digits = 3)
(table(compra11_r$NORDEN))

raros <- compra11_r |> 
  filter(NORDEN > 5)
mean(is.na(raros$LTRABA)) * 100

# Otro pariente
round(prop.table(table(compra11_r$OPA_NORDEN)), digits = 3)
mean(is.na(compra11_r$OPA_NORDEN)) * 100

# Trabajo
mean(is.na(compra11_r$LTRABA)) * 100
round(prop.table(table(compra11_r$LTRABA)), digits = 3)
mean(is.na(compra11$LTRABA)) * 100

# Año de llegada a la vivienda
mean(compra11_r$ANORES)
round(prop.table(table(compra11_r$ANORES)), digits = 3)

# Condición dentro del núcleo
round(prop.table(table(compra11_r$TIPOPER)), digits = 3)
compra11_r %>%
  count(TIPOPER) %>%
  mutate(proporcion = n / sum(n) * 100) %>%
  ggplot(aes(x = TIPOPER, y = proporcion, label = paste0(round(proporcion, 2), "%"))) +
  geom_bar(stat = "identity", fill = "skyblue") +
  geom_text(vjust = -0.5) +
  labs(title = "Distribución de TIPOPER", x = "TIPOPER", y = "Proporción (%)") +
  theme_minimal()

# Estructura del hogar
round(prop.table(table(compra11_r$ESTHOG)), digits = 3)

# Régimen de tenencia
round(prop.table(table(compra11_r$TENEN_r)), digits = 3)

# Provincias
head(sort(prop.table(table(compra11_r$PROV_LITERAL)), decreasing = TRUE), 3)
tail(sort(prop.table(table(compra11_r$PROV_LITERAL)), decreasing = TRUE), 3)

```

### 2021

-   Edad. La edad es más joven que en 2011 lo cual me hace sospechar que estoy añadiendo casos de herencia, por ejemplo, porque no puedo filtrar tan bien en este año.

-   Número de orden. Un 46,6% es número 1, un 53,4% número 2.

-   Orden de pariente. El 52.5% de los casos vive sin otro familiar. Es más alto que en 2011. En la mayoría de casos éstos son de orden 3 (23.3%) o 4 (15.7%).

-   Trabajo. Un 26% no trabajan. La población joven con otros regímenes de tenencia, sin filtrar por compra, es un 32%. Un 37% trabaja en un municipio distinto al que reside.

-   Año de llegada a la vivienda. La media es 2017, similar a 2011 (con 10 años más).

-   Condición dentro del núcleo. La mayoría 58,5% viven en pareja. Hay el doble de personas que viven solas, que en 2011, un 36,6%. Hay también más madres solteras, pero igual padres solteros.

-   Estructura del hogar. La mayoría de hogares son familias en pareja con hijos (37,2%), pero menos que en 2011 (46,2%). Continúa pareja sin hijos 24,5% y 'otro tipo de hogar', pero ha aumentado mucho más este otro tipo de hogar en 2021, triplicándose.

```{r}
# Edad
mean(compra21_r$VAREDAD)
round(prop.table(table(compra21_r$VAREDAD)), digits = 3)
hist(compra21_r$VAREDAD)

# Número de orden
round(prop.table(table(compra21_r$NORDEN)), digits = 3)
(table(compra21_r$NORDEN))

raros <- compra21_r |> 
  mutate(NORDEN = as.numeric(NORDEN)) |> 
  filter(NORDEN > 05)

mean(raros$LTRAB == " ") * 100
mean(compra21_r$LTRAB == " ") * 100

# Otro pariente
round(prop.table(table(compra21_r$NORDEN_OPA)), digits = 3)

# Trabajo
round(prop.table(table(compra21_r$LTRAB)), digits = 3)

# Año de llegada a la vivienda
# Habría que transofrmar la variable
compra21_r$VARANORES_r <- as.numeric(compra21_r$VARANORES_r)

mean(compra21_r$VARANORES_r)
round(prop.table(table(compra21_r$ANORES)), digits = 3)

# Condición dentro del núcleo
round(prop.table(table(compra21_r$TIPOPER)), digits = 3)

# Estructura del hogar
round(prop.table(table(compra21_r$ESTRUC_HOG)), digits = 3)

# Provincias
head(sort(prop.table(table(compra21_r$PROV_LITERAL)), decreasing = TRUE), 3)
tail(sort(prop.table(table(compra21_r$PROV_LITERAL)), decreasing = TRUE), 3)
```

# ¿Dónde compran?

### En 2011 - Crear variables

```{r}

# Por municipio
compra11 <- compra11 |> 
  group_by(cusec) |> 
  mutate(
    Compra11Mun = round((sum(TENEN_VIV == "Compra") / n()) * 100, 2),
    Herencia11Mun = round((sum(TENEN_VIV == "Herencia o donación") / n()) * 100, 2),
    Alquiler11Mun = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro11Mun = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2)) |> 
  ungroup()

# Por provincia
compra11 <- compra11 |> 
  group_by(CPRO) |> 
  mutate(
    Compra11Prov = round((sum(TENEN_VIV == "Compra") / n()) * 100, 2),
    Herencia11Prov = round((sum(TENEN_VIV == "Herencia o donación") / n()) * 100, 2),
    Alquiler11Prov = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro11Prov = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2)) |>   ungroup()

# Por CCAA
compra11 <- compra11 |> 
  group_by(CCAA) |> 
  mutate(
    Compra11CCAA = round((sum(TENEN_VIV == "Compra") / n()) * 100, 2),
    Herencia11CCAA = round((sum(TENEN_VIV == "Herencia o donación") / n()) * 100, 2),
    Alquiler11CCAA = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro11CCAA = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2)) |>   ungroup()


```

### En 2021 - Crear variables

```{r}

# Por municipio
compra21 <- compra21 |> 
  group_by(cusec) |> 
  mutate(
    Propiedad21Mun = round((sum(TENEN_VIV == "Propiedad") / n()) * 100, 2),
    Alquiler21Mun = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro21Mun = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2)) |> 
  ungroup()

# Por provincia
compra21 <- compra21 |> 
  group_by(CPRO) |> 
  mutate(
    Propiedad21Prov = round((sum(TENEN_VIV == "Propiedad") / n()) * 100, 2),
    Alquiler21Prov = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro21Prov = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2)) |>   ungroup()

# Por CCAA
compra21 <- compra21 |> 
  group_by(CCAA) |> 
  mutate(
    Propiedad21CCAA = round((sum(TENEN_VIV == "Propiedad") / n()) * 100, 2),
    Alquiler21CCAA = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro21CCAA = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2)) |>   ungroup()

```

## Análisis

## En 2011

### Por municipio

-   Propiedad 2021 con filtro (nuevo). Los municipios con más propiedad juvenil con las características que hemos definido (no vive con los padres, se mudó por última vez con mínimo 18 años...) son Martos con un 89% de propiedad frente a otros regímenes de tenencia, otros pueblos de Jaén o andaluces. Los que menos son catalanes, las islas.

-   Compra 2011 con filtro (nuevo). Los municipios con más compra juvenil son municipios pequeños de Zamora o municipios valencianos y andaluces.

-   Herencia 2011 con filtro (nuevo). Los municipios con más jovenes por herencia son municipios pequeños de Las Palmas, Galicia. La gran mayoría son este tipo de municipios.

```{r}

# Propiedad
top_propiedad_2011 <- propiedad %>%
  arrange(desc(Propiedad11Mun)) %>%
  distinct(Propiedad11Mun, .keep_all = TRUE) |> 
  select(Propiedad11Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

# Compra
top_compra_2011 <- compra11 %>%
  arrange(desc(Compra11Mun)) %>%
  distinct(Compra11Mun, .keep_all = TRUE) |> 
  select(Compra11Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

# Herencia
top_herencia_2011 <- compra11 %>%
  arrange(desc(Herencia11Mun)) %>%
  distinct(cusec, .keep_all = TRUE) |> 
  select(Herencia11Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

# Alquiler
top_alquiler_2011 <- compra11 %>%
  arrange(desc(Alquiler11Mun)) %>%
  distinct(cusec, .keep_all = TRUE) |> 
  select(Alquiler11Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

# Otro
top_otro_2011 <- compra11 %>%
  arrange(desc(Otro11Mun)) %>%
  distinct(cusec, .keep_all = TRUE) |> 
  select(Otro11Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

top_propiedad_2011
top_compra_2011
top_herencia_2011
top_alquiler_2011
top_otro_2011

```

### Por provincia

```{r}

# Compra
top_compra_2011 <- compra11 |> 
    distinct(CPRO, .keep_all = TRUE) |> 
    arrange(desc(Compra11Prov)) |> 
    select(Compra11Prov, PROV_LITERAL, CCAA)

# Herencia
top_herencia_2011 <- compra11 |> 
    distinct(CPRO, .keep_all = TRUE) |> 
    arrange(desc(Herencia11Prov)) |> 
    select(Herencia11Prov, PROV_LITERAL, CCAA)

# Alquiler
top_alquiler_2011 <- compra11 %>%
  arrange(desc(Alquiler11Prov)) %>%
  distinct(CPRO, .keep_all = TRUE) |> 
  select(Alquiler11Prov, PROV_LITERAL, CCAA)

# Otro
top_otro_2011 <- compra11 %>%
  arrange(desc(Otro11Prov)) %>%
  distinct(CPRO, .keep_all = TRUE) |> 
  select(Otro11Prov, PROV_LITERAL, CCAA)

top_compra_2011
top_herencia_2011
top_alquiler_2011
top_otro_2011

```

### Por CCAA

```{r}

# Compra
top_compra_2011 <- compra11 |> 
    distinct(CCAA, .keep_all = TRUE) |> 
    arrange(desc(Compra11CCAA)) |> 
    select(Compra11CCAA, CCAA)

# Herencia
top_herencia_2011 <- compra11 |> 
    distinct(CCAA, .keep_all = TRUE) |> 
    arrange(desc(Herencia11CCAA)) |> 
    select(Herencia11CCAA, CCAA)

# Alquiler
top_alquiler_2011 <- compra11 %>%
  arrange(desc(Alquiler11CCAA)) %>%
  distinct(CCAA, .keep_all = TRUE) |> 
  select(Alquiler11CCAA, CCAA)

# Otro
top_otro_2011 <- compra11 %>%
  arrange(desc(Otro11CCAA)) %>%
  distinct(CCAA, .keep_all = TRUE) |> 
  select(Otro11CCAA, CCAA)

top_compra_2011
top_herencia_2011
top_alquiler_2011
top_otro_2011

```

## En 2021

### Por municipio

```{r}

# Propiedad
top_propiedad_2021 <- compra21 |> 
    distinct(cusec, .keep_all = TRUE) |> 
    arrange(desc(Propiedad21Mun)) |> 
    select(Propiedad21Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

# Alquiler
top_alquiler_2021 <- compra21 |> 
    distinct(cusec, .keep_all = TRUE) |> 
    arrange(desc(Alquiler21Mun)) |> 
    select(Alquiler21Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

# Otro
top_otro_2021 <- compra21 |> 
    distinct(cusec, .keep_all = TRUE) |> 
    arrange(desc(Otro21Mun)) |> 
    select(Propiedad21Mun, MUN_LITERAL, PROV_LITERAL, CCAA)

top_propiedad_2021
top_alquiler_2021
top_otro_2021
```

### Por provincia

```{r}

# Propiedad
top_propiedad_2021 <- compra21 |> 
    distinct(CPRO, .keep_all = TRUE) |> 
    arrange(desc(Propiedad21Prov)) |> 
    select(Propiedad21Prov, PROV_LITERAL, CCAA)

# Alquiler
top_alquiler_2021 <- compra21 |> 
    distinct(CPRO, .keep_all = TRUE) |> 
    arrange(desc(Alquiler21Prov)) |> 
    select(Alquiler21Prov, PROV_LITERAL, CCAA)

# Otro
top_otro_2021 <- compra21 |> 
    distinct(CPRO, .keep_all = TRUE) |> 
    arrange(desc(Otro21Prov)) |> 
    select(Propiedad21Mun, PROV_LITERAL, CCAA)

top_propiedad_2021
top_alquiler_2021
top_otro_2021
```

### Por CCAA

```{r}

# Propiedad
top_propiedad_2021 <- compra21 |> 
    distinct(CCAA, .keep_all = TRUE) |> 
    arrange(desc(Propiedad21CCAA)) |> 
    select(Propiedad21CCAA, CCAA)

# Alquiler
top_propiedad_2021 <- compra21 |> 
    distinct(CCAA, .keep_all = TRUE) |> 
    arrange(desc(Alquiler21CCAA)) |> 
    select(Alquiler21CCAA, CCAA)

# Otro
top_propiedad_2021 <- compra21 |> 
    distinct(CCAA, .keep_all = TRUE) |> 
    arrange(desc(Otro21CCAA)) |> 
    select(Otro21CCAA, CCAA)

```

## Mapas

## En 2011

### Por provincia

```{r, fig.height=6, fig.width=12}

library(mapSpain)
  
esp_can <- esp_get_country() 
can_prov <- esp_get_can_provinces()
can_box <- esp_get_can_box() 
munic <- esp_get_munic() 

provic <- esp_get_prov() |> 
  mutate(CPRO = cpro)

mapa <- compra11 |> 
  select(CPRO, Compra11Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

# Compra
p1 <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Compra11Prov), color = "black", size = 1) + 
        geom_sf_text(data = mapa, aes(label = round(Compra11Prov, 1)), color = "black", size = 2.5, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas
  theme_void() +  
  labs(title = "Porcentaje de compra por provincia 2011") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1)

# Herencia o donación

mapa <- compra11 |> 
  select(CPRO, Herencia11Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p2 <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Herencia11Prov), color = "black", size = 1) + 
        geom_sf_text(data = mapa, aes(label = round(Herencia11Prov, 1)), color = "black", size = 2.5, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas
  theme_void() +  
  labs(title = "Porcentaje de herencia/donación por provincia 2011") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1)

# Alquiler
mapa <- compra11 |> 
  select(CPRO, Alquiler11Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p3 <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Alquiler11Prov), color = "black", size = 1) + 
        geom_sf_text(data = mapa, aes(label = round(Alquiler11Prov, 1)), color = "black", size = 2.5, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas
  theme_void() +  
  labs(title = "Porcentaje de alquiler por provincia 2011") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1)

# Otro
mapa <- compra11 |> 
  select(CPRO, Otro11Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p4 <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Otro11Prov), color = "black", size = 1) + 
        geom_sf_text(data = mapa, aes(label = round(Otro11Prov, 1)), color = "black", size = 2.5, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas
  theme_void() +  
  labs(title = "Porcentaje de otro por provincia 2011") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1)


ggarrange(p1, p2, p3, p4, ncol=2, nrow = 2)


```

## En 2021

### Por provincia

```{r, fig.height=6, fig.width=12}

library(mapSpain)

esp_can <- esp_get_country() 
can_prov <- esp_get_can_provinces()
can_box <- esp_get_can_box() 
munic <- esp_get_munic() 

provic <- esp_get_prov() |> 
  mutate(CPRO = cpro)

mapa <- compra21 |> 
  select(CPRO, Propiedad21Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

# Propiedad
p1 <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Propiedad21Prov), color = "black", size = 1) + 
        geom_sf_text(data = mapa, aes(label = round(Propiedad21Prov, 1)), color = "black", size = 2.5, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas
  theme_void() +  
  labs(title = "Porcentaje de propiedad por provincia 2021") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1)


# Alquiler
mapa <- compra21 |> 
  select(CPRO, Alquiler21Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p3 <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Alquiler21Prov), color = "black", size = 1) + 
        geom_sf_text(data = mapa, aes(label = round(Alquiler21Prov, 1)), color = "black", size = 2.5, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas
  theme_void() +  
  labs(title = "Porcentaje de alquiler por provincia 2021") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1)

# Otro
mapa <- compra21 |> 
  select(CPRO, Otro21Prov) |> 
  distinct(CPRO, .keep_all = TRUE)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")

p4 <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = Otro21Prov), color = "black", size = 1) + 
        geom_sf_text(data = mapa, aes(label = round(Otro21Prov, 1)), color = "black", size = 2.5, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas
  theme_void() +  
  labs(title = "Porcentaje de otro por provincia 2011") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6)) + 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_viridis_c(option = "C", direction = -1)


ggarrange(p1, p3, p4, ncol=2, nrow = 2)

```

## Filtro vs no filtro

Juntar tablas

```{r}

compra11_mun <- compra11 |> 
  distinct(cusec, .keep_all=T)

compra21_mun <- compra21 |> 
  distinct(cusec, .keep_all=T)

compra_total <- compra11_mun |> 
  left_join(compra21_mun, by = "cusec") |> 
    rename_with(~str_replace(., "\\.y$", ""), .cols = ends_with(".y")) |>
  select(-ends_with(".x")) |> 
  distinct(cusec, .keep_all=T)
  
```

## En 2011

Las provincias con menos compra son Teruel, Melilla, provincias gallegas, las Islas. Son provincias más envejecidas o con características particulares.

```{r}

# Top municipios con más compra en 2011
top_propiedad_2011_filtro_mun <- compra11 %>%
  arrange(desc(Compra11Mun)) %>%
  distinct(cusec, .keep_all = TRUE) |> 
  select(Compra11Mun, MUN_LITERAL, PROV_LITERAL)

# Top municipios con más propiedad en 2011 NO FILTRO
#top_propiedad_2011_mun <- jovenes_total %>%
#  arrange(desc(Compra11Mun)) %>%
#    distinct(cusec, .keep_all = TRUE) |> 
#    select(Compra11Mun, MUN_LITERAL, PROV_LITERAL)

# Top provincias con más compra en 2011
top_propiedad_2011_filtro <- compra11 %>%
  arrange(desc(Compra11Prov)) %>%
  distinct(CPRO, .keep_all = TRUE) |> 
  select(Compra11Prov, PROV_LITERAL)

# Top provincias con más propiedad en 2011 NO FILTRO
#top_propiedad_2011 <- jovenes_total %>%
#  arrange(desc(Propiedad11Prov)) %>%
#    distinct(CPRO, .keep_all = TRUE) |> 
#    select(Propiedad11Prov, MUN_LITERAL, PROV_LITERAL)

# Top municipios con más HERENCIA en 2011
top_herencia_2011_filtro_mun <- compra11 %>%
  arrange(desc(Herencia11Mun)) %>%
  distinct(cusec, .keep_all = TRUE) |> 
  select(Herencia11Mun, MUN_LITERAL, PROV_LITERAL)

# Top provincias con más HERENCIA en 2011
top_herencia_2011_filtro <- compra11 %>%
  arrange(desc(Herencia11Prov)) %>%
  distinct(CPRO, .keep_all = TRUE) |> 
  select(Herencia11Prov, PROV_LITERAL)


View(top_propiedad_2011_filtro_mun)
#top_propiedad_2011_mun
View(top_propiedad_2011_filtro)
#top_propiedad_2011
View(top_herencia_2011_filtro_mun)
View(top_herencia_2011_filtro)

```

## En 2021

-   2021 con filtro. La provincia con más propiedad joven es Jaén con un 77%, seguido de Málaga, Córdoba, Cádiz, Ciudad Real... la mayoría de provincias andaluzas, seguido de Murcia, Extremadura. Las provincias con menos propiedad son Barcelona, Girona y Madrid.

-   2021 sin filtro. Cambia el orden de las provincias andaluzas, añade algunas de Castilla y León. Hay más propiedad en Madrid.

-   2021 con filtro. Se posiciona en primer lugar Cádiz (76%), seguido de Alicante, precisamente provincias con alto turismo.

Las provincias con menos propiedad son Barcelona, las islas, Girona. Vemos menos claramente las provincias más envejecidas como las gallegas. Sin embargo sí se mantiene de forma muy similar los municipios con menos propiedad: Cataluña, Barcelona, Islas Baleares. Quizá ha cambiado más los municipios donde se compra más, pero menos los que no se compra mucho.

Nerja sale el top 1, vemos que en 2011 está bastante baja la propiedad ahí, así que hay un aumento muy significativo. Hay muchos municipios andaluces con mucha propiedad en 2021. Por qué? Hay que tener cuidado de no estar incluyendo herencia, pero:

-   Andalucía es precisamente de las CCAA con menos población envejecida; no hay razón por la cual haya más herencia ahí que en otras CCAA. Precisamente, habría más en Galicia por ejemplo.

-   Si vemos la herencia en 2011, vemos estas provincias gallegas y Jaén, Cuenca, Teruel, Cáceres. No vemos que haya abundante presencia andaluza, por lo que indicaría que este aumento en Andalucía no debería deberse a mezclar la compra con la herencia, sino ser genuino

-   He visto en el INE que ha aumentado mucho las herencias en Andalucía... la CCAA con más aumento <https://www.ine.es/jaxiT3/Datos.htm?t=6154#_tabs-grafico>

-   Va a ser que mi 'diferencia' solo muestra dónde ha aumentado la herencia???? Puedo reducir este efecto poniendo no sólo la compra en 2011, sino toda la propiedad?

-   Por otra parte, y si lo hago viendo el alquiler? dónde se ha reducido el alquiler es muy similar a decir dónde ha aumentado la compra...o hasta qué punto es eso mejor?

-   Las top herencia son las provincias que luego salen con más aumento de propiedad al ver la diferencia! POR QUÉ? -\> debe estar contando como 'propiedad' en 2021 la herencia, y contrasta con la poca compra real en 2011.

Buscar base de datos de herencias por municipio, o intentar reducir ese efecto con datos de cuánto ha aumentado la herencia según provincia, o hacer con propieedad por compra e hipoteca.

Mañana: busco herencias por municipios, intento restar a la propiedad de 2021 el % que correspondería a la herencia.

```{r}

# Top municipios con más compra en 2021
top_propiedad_2021_filtro_mun <- compra21 %>%
  arrange(desc(Propiedad21Mun)) %>%
  distinct(cusec, .keep_all = TRUE) |> 
  select(Propiedad21Mun, MUN_LITERAL, PROV_LITERAL)

# Top municipios con más propiedad en 2021 NO FILTRO
#top_propiedad_2021_mun <- jovenes_total %>%
#  arrange(desc(Propiedad21Mun)) %>%
#    distinct(cusec, .keep_all = TRUE) |> 
#    select(Propiedad21Mun, PROV_LITERAL)

# Top provincias con más compra en 2021
top_propiedad_2021_filtro <- compra21 %>%
  arrange(desc(Propiedad21Prov)) %>%
  distinct(CPRO, .keep_all = TRUE) |> 
  select(Propiedad21Prov, PROV_LITERAL)

# Top provincias con más propiedad en 2021 NO FILTRO
#top_propiedad_2021 <- jovenes_total %>%
#  arrange(desc(Propiedad21Prov)) %>%
#    distinct(CPRO, .keep_all = TRUE) |> 
#    select(Propiedad21Prov, PROV_LITERAL)

View(top_propiedad_2021_filtro_mun)
#top_propiedad_2021_mun
View(top_propiedad_2021_filtro)
#top_propiedad_2021

```

## Diferencias entre ambos años

El problema es que, si en 2011 sólo incluyo compra pero en 2021 se me están colando casos de herencia, al hacer las diferencias de propiedad me sale acentuado este problema. Quizá en un municipio no hay nada de compra juvenil en 2011, pero como en 2021 incluyo alguna herencia, estoy viendo un gran aumento en ese municipio de propiedad.

El caso de Jaén \<= 2000. Hay 1448 jóvenes en 2011 que residen en este grupo de municipios. En 2021, hay 812. De los que filtramos con las características que nos interesan, hay 457 en 2011 y 300 en 2021. Sin embargo, de compra hay 257 en 2011 y en 2021 hay 240 de propiedad.

```{r}
jaen11 <- jovenes11 |>   
  filter(cusec == "23991")
jaen21 <- jovenes |>   
  filter(cusec == "23991")

jaen11 <- compra11 |>   
  filter(cusec == "23991")
jaen21 <- compra21 |>   
  filter(cusec == "23991")

jaen11 <- compra11_r |>   
  filter(cusec == "23991")
jaen21 <- compra21_r |>   
  filter(cusec == "23991")

(table(compra11$TENEN_r))

```

Si comparo los municipios con más herencia en 2011, no son los mismos que los municipios con más aumento de propiedad.

### Por municipio

-   Propiedad de 2021 - Compra de 2011. Donde mas ha aumentado son muchos municipios rurales... me precupa no medir bien la compra solo en propiedad en vez de herencia.

```{r}

# Propiedad
compra_total <- compra_total |> 
  mutate(
    PropiedadDifMun = Propiedad21Mun - Compra11Mun)

View(compra_total |> 
    distinct(PropiedadDifMun, .keep_all = TRUE) |> 
  arrange(desc(PropiedadDifMun)) |> 
    select(PropiedadDifMun, MUN_LITERAL, PROV_LITERAL, CCAA))

# Alquiler
compra_total <- compra_total |> 
  mutate(
    AlquilerDifMun = Alquiler21Mun - Alquiler11Mun)

View(compra_total %>%
    distinct(AlquilerDifMun, .keep_all = TRUE) |> 
  arrange(desc(AlquilerDifMun)) %>%
    select(AlquilerDifMun, MUN_LITERAL, PROV_LITERAL, CCAA))


# Otro
compra_total <- compra_total |> 
  mutate(
    OtroDifProv = Otro21Mun - Otro11Mun)

compra_total %>%
    distinct(OtroDiMun, .keep_all = TRUE) |> 
  arrange(desc(OtroDiMun)) %>%
    select(OtroDiMun, MUN_LITERAL, PROV_LITERAL, CCAA)


```

### Por provincia

```{r}
#  Propiedad
compra_total <- compra_total |>
  group_by(CPRO) |> 
  mutate(
    PropiedadDifProv = Propiedad21Prov - Compra11Prov) |> 
  ungroup()


View(compra_total %>%
    distinct(PropiedadDifProv, .keep_all = TRUE) |> 
  arrange(desc(PropiedadDifProv)) %>%
    select(PropiedadDifProv, PROV_LITERAL, CCAA))

# Alquiler
compra_total <- compra_total |>
  group_by(CPRO) |> 
  mutate(
    AlquilerDifProv = Alquiler21Prov - Alquiler11Prov) |> 
  ungroup()

compra_total %>%
    distinct(AlquilerDifProv, .keep_all = TRUE) |> 
  arrange(desc(AlquilerDifProv)) %>%
    select(AlquilerDifProv, PROV_LITERAL, CCAA)

# Otro
compra_total <- compra_total |>
  group_by(CPRO) |> 
  mutate(
    OtroDifProv = Otro21Prov - Otro11Prov) |> 
  ungroup()

View(compra_total %>%
    distinct(OtroDifProv, .keep_all = TRUE) |> 
  arrange(desc(OtroDifProv)) %>%
    select(OtroDifProv, PROV_LITERAL, CCAA))
```

### Por CCAA

```{r}

#  Propiedad
compra_total <- compra_total |>
  group_by(CCAA) |> 
  mutate(
    PropiedadDifCCAA = Propiedad21CCAA - Compra11CCAA) |> 
  ungroup()


compra_total %>%
    distinct(PropiedadDifCCAA, .keep_all = TRUE) |> 
  arrange(desc(PropiedadDifCCAA)) %>%
    select(PropiedadDifCCAA, CCAA)

# Alquiler
compra_total <- compra_total |>
  group_by(CCAA) |> 
  mutate(
    AlquilerDifCCAA = Alquiler21CCAA - Alquiler11CCAA) |> 
  ungroup()

compra_total %>%
    distinct(AlquilerDifProv, .keep_all = TRUE) |> 
  arrange(desc(AlquilerDifProv)) %>%
    select(AlquilerDifProv, MUN_LITERAL, PROV_LITERAL, CMUN)

# Otro
compra_total <- compra_total |>
  group_by(CCAA) |> 
  mutate(
    OtroDifProv = Otro21Prov - Otro11Prov) |> 
  ungroup()

compra_total %>%
    distinct(OtroDifProv, .keep_all = TRUE) |> 
  arrange(desc(OtroDifProv)) %>%
    select(OtroDifProv, MUN_LITERAL, PROV_LITERAL, CMUN)

```

-   Preparar todos los análisis claramente, pero NO HACERLOS. Dejarlo cuando esté perfe
-   Cómo defino bien sólo COMPRA
-   Preparar el resto de variables para hacer clusters/variabilidad

analizar los municinipios..

Hacer el analisis de componentes pero con las varibales que hablamos y con este perfil de solo compra (?)

### mapa diferencia provincias

```{r, fig.height=6, fig.width=12}
# Mapa por provincias PROPIEDAD

library(maepSpain)

esp_can <- esp_get_country() 
can_prov <- esp_get_can_provinces()
can_box <- esp_get_can_box() 
munic <- esp_get_munic() 

provic <- esp_get_prov() |> 
  mutate(CPRO = cpro)

mapa <- compra_total |> 
  select(CPRO, PropiedadDifProv)

mapa <- provic |> 
  left_join(mapa, by = "CPRO")
  
mapa_propiedad_prov <- ggplot(esp_can) +
  geom_sf() +
  geom_sf(data = can_prov) +
  geom_sf(data = can_box) + 
  geom_sf(data = mapa, aes(fill = PropiedadDifProv), color = "black", size = 1) + 
    geom_sf_text(data = mapa, aes(label = round(PropiedadDifProv, 1)), color = "black", size = 3, check_overlap = TRUE, nudge_y = 0.1) +  # Agregar etiquetas
  theme_void() +  
  labs(title = "Difference of young people bought houses from 2011 to 2021 by province") +  
  theme(legend.position = c(0.18, 0.55),    
        legend.justification = "center",   
        legend.background = element_rect(fill = NULL, colour = "black"),
        legend.margin = margin(6, 6, 6, 6))+ 
  guides(fill = guide_legend(ncol = 2)) + 
  coord_sf() +
  scale_fill_gradient2(low = "red", mid = "white", high = "green", midpoint = 0)

mapa_propiedad_prov


```

### Tema herencia

Primero hacer que compra11 incluya toda la propiedad

```{r}

compra11_mezcla <- compra11 |> 
  filter(TENEN_r %in% c("Propiedad por compra, pagada", "Propiedad por compra, pagos pendientes", "Propiedad por herencia o donación"))

compra11_mezcla <- compra11 |> 
  group_by(cusec) |> 
  mutate(
    Propiedad11Mun = round((sum(TENEN_VIV %in% c("Compra", "Herencia o donación")) / n()) * 100, 2),
    Alquiler11Mun = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro11Mun = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2)) |>
  ungroup() |> 
  distinct(cusec, .keep_all = T)

# top propiedad compra + herencia 2011
View(top_propiedad_2011_filtro_mun <- compra11_mezcla %>%
  arrange(desc(Propiedad11Mun)) %>%
  distinct(cusec, .keep_all = TRUE) |> 
  select(Propiedad11Mun, MUN_LITERAL, PROV_LITERAL))

# top compra 2011
View(top_propiedad_2011_filtro_mun <- compra11 %>%
  arrange(desc(Compra11Mun)) %>%
  distinct(cusec, .keep_all = TRUE) |> 
  select(Compra11Mun, MUN_LITERAL, PROV_LITERAL))

# mezcla
compra_total_mezcla <- compra11_mezcla |> 
  left_join(compra21_mun, by = "cusec") |> 
    rename_with(~str_replace(., "\\.y$", ""), .cols = ends_with(".y")) |>
  select(-ends_with(".x")) |> 
  distinct(cusec, .keep_all=T)

compra_total_mezcla <- compra_total_mezcla |> 
  mutate(
    PropiedadDifMun = Propiedad21Mun - Propiedad11Mun)

# top dif propiedad hernecia + compra
View(compra_total_mezcla |> 
    distinct(PropiedadDifMun, .keep_all = TRUE) |> 
  arrange(desc(PropiedadDifMun)) |> 
    select(PropiedadDifMun, MUN_LITERAL, PROV_LITERAL, CCAA))

# normal
compra_total <- compra11_mun |> 
  left_join(compra21_mun, by = "cusec") |> 
    rename_with(~str_replace(., "\\.y$", ""), .cols = ends_with(".y")) |>
  select(-ends_with(".x")) |> 
  distinct(cusec, .keep_all=T)

compra_total <- compra_total |> 
  mutate(
    PropiedadDifMun = Propiedad21Mun - Compra11Mun)

# top dif propiedad compra - propiedad
View(compra_total |> 
    distinct(PropiedadDifMun, .keep_all = TRUE) |> 
  arrange(desc(PropiedadDifMun)) |> 
    select(PropiedadDifMun, MUN_LITERAL, PROV_LITERAL, CCAA))

#top compra normal
View(compra11 %>%
  arrange(desc(Compra11Mun)) %>%
  distinct(cusec, .keep_all = TRUE) |> 
  select(Compra11Mun, MUN_LITERAL, PROV_LITERAL))

# top herencia 2011
top_herencia_2011_filtro_mun <- compra11 %>%
  arrange(desc(Herencia11Mun)) %>%
  distinct(cusec, .keep_all = TRUE) |> 
  select(Herencia11Mun, MUN_LITERAL, PROV_LITERAL)

View(top_herencia_2011_filtro_mun)

# top propiedad 2021
top_propiedad_2021_filtro_mun <- compra21 %>%
  arrange(desc(Propiedad21Mun)) %>%
  distinct(cusec, .keep_all = TRUE) |> 
  select(Propiedad21Mun, MUN_LITERAL, PROV_LITERAL)

View(top_propiedad_2021_filtro_mun)
```

### Intentar estimar la herencia en 2021

Ver aumento de herencia por provincia. A la cantidad de viviendas 'compradas' en 2021, resto ese porcentaje por provincia. a ver qué pasa...

De todas las viviendas principales en propiedad, tantas eran de herencia

Problema con datos exactos: la herencia externa del ine incluye herencia de viviendas secundarias.

<https://www.ine.es/jaxiT3/Datos.htm?t=6154#_tabs-tabla>

Tengo el porcentaje de herencia en 2021. Podría estimar el número real de viviendas compradas mediante restar ese porcentaje al total de propiedad? Pero eso sería asumir que en mis filtros me quedo con la misma cantidad de herencia que de compra real. Y no es así, me quedo con más ocmpras. Quizá hacer esto antes, y luego hacer lo de filtrar?

-   Ver cuántos casos me quito de encima si reduzco antes de filtros y luego filtro. Cuántos casos se van?

-   Se van mas casos que si filtro y luego reduzco? (deberia ser asi creo yo)

Solución mala al problema: pensar en dónde ha aumentado la propiedad, sin diferenciar compra y herencia. Dónde no ha aumentado el alquiler sin más.

-   Quizá es más certero ver en qué municipios ha aumentado mucho el alquilelr como forma de ver dónde ha disminuido la propiedad. Porque propiedad-alquiler siempre van de la mano, pero la herencia es constante...

-   Ver cómo cambian los top municipios que han perdido más alquiler vs los municipios que han tenido más compra. ¿Veo que hay menos municipios con mayor herencia? Quizá esto es lo más sencillo y efectivo que liarme a hacer estimaciones raras. Quizá lo de herencia me puede servir de 'comprobación' ? Pero se supone que un aumento en el alquiler siempre se corresponde con un descenso en propiedad, y viceversa. Y la herencia sí es estable, o por lo menos, solo ha experimentado un aumento en estos años.

-   puedo ver en que municipios hay mas herencia en 2021. ver si estos municipios son los mismos en los que se ha reducido mucho el alquiler.

o si hay datos de herencia??? <https://www.ine.es/jaxi/Tabla.htm?tpx=56582&L=0>

<https://www.fotocasa.es/fotocasa-life/compraventa/se-incrementa-el-perfil-de-herederos-jovenes-con-vivienda-en-venta-o-alquiler/>

### Todo propiedad

Nombres, 944, CCAA

```{r}

microdatos2011 <- read_sav("Microdatos2011/Personas/poblacion_2011_v2.sav")

propiedad <- microdatos2011 |> 
  select(CPRO, CMUN)

# Crear los códigos cusec de los municipios no especificados
cusec_991 <- sprintf("%05d", seq(1991, 52991, by = 1000))
cusec_992 <- sprintf("%05d", seq(1992, 52992, by = 1000))
cusec_993 <- sprintf("%05d", seq(1993, 52993, by = 1000))
cusec_994 <- sprintf("%05d", seq(1994, 52994, by = 1000))
cusec <- c(cusec_991, cusec_992, cusec_993, cusec_994)

MUN_LITERAL <- 
  ifelse(substr(cusec, 4, 5) == "91","<=2000",
  ifelse(substr(cusec, 4, 5) == "92", "2001 <= 5000",
  ifelse(substr(cusec, 4, 5) == "93", "5001 <= 10000",
  ifelse(substr(cusec, 4, 5) == "94", "10001 <= 20000","Otros"))))

df_rural <- data.frame(MUN_LITERAL, cusec)

# Obtener nombres de todos los municipios y provincias
locations <- read_excel("vivienda turística/exp_viv_turistica_tabla5_FEB2021.xlsx", sheet = 3, na = "Dato protegido por secreto estadístico.")

nombres_municipios <- locations |> 
  select(MUN_LITERAL, MUN) |> 
  rename(cusec = MUN) |> 
  distinct(cusec, .keep_all = TRUE)

nombres_provincias <- locations |> 
  select(PROV_LITERAL, PROV) |> 
  rename(CPRO = PROV) |> 
  distinct(CPRO, .keep_all = TRUE)

nombres_municipios <- rbind(nombres_municipios, df_rural)

ccaas <- data.frame(
  CodigoProvincia = c("01", "02", "03", "04", "33", "05", "06", "08", "09", "10", "11", "39", "12", "13", "14", "16", "17", "18", "19", "20", "21", "22", "23", "07", "24", "15", "35", "25", "26", "27", "28", "29", "30", "31", "32", "34", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49", "50", "51", "52"),
  CCAA = c("País Vasco", "Castilla-La Mancha", "Comunidad Valenciana", "Andalucía", "Asturias", "Castilla y León", "Extremadura", "Cataluña", "Castilla y León", "Extremadura", "Andalucía", "Cantabria", "Comunidad Valenciana", "Castilla-La Mancha", "Andalucía", "Castilla-La Mancha", "Cataluña", "Andalucía", "Castilla-La Mancha", "País Vasco", "Andalucía", "Aragón", "Andalucía", "Islas Baleares", "Castilla y León", "Galicia", "Canarias", "Cataluña", "La Rioja", "Galicia", "Comunidad de Madrid", "Andalucía", "Comunidad de Murcia", "Comunidad Foral de Navarra", "Galicia", "Castilla y León", "Galicia", "Castilla y León", "Canarias", "Cantabria", "Castilla y León", "Andalucía", "Castilla y León", "Cataluña", "Aragón", "Castilla-La Mancha", "Comunidad Valenciana", "Castilla y León", "País Vasco", "Castilla y León", "Aragón", "Ceuta", "Melilla"))

# Añadir nombres de provincias y municipios
propiedad <- propiedad |> 
  mutate(
    CMUN = str_pad(CMUN, width = 3, side = "left", pad = "0"),
    CPRO = str_pad(CPRO, width = 2, side = "left", pad = "0")) |> 
   mutate(  
    CPRO = trimws(CPRO),
    CMUN = trimws(CMUN),
    cusec = paste0(CPRO, CMUN)) |> 
  left_join(nombres_municipios, by = "cusec") |> 
  left_join(nombres_provincias, by = "CPRO") |> 
  left_join(ccaas, by = c("CPRO" = "CodigoProvincia")) |> 
  distinct(cusec, .keep_all = T)

```

Municipios rurales

```{r}

load("Microdatos2021/Personas/R/CensoPersonas_2021.RData")

microdatos2021 <- Microdatos

mun21 <- microdatos2021 |> 
  select(CPRO, CMUN) |>    
  mutate(CPRO = trimws(CPRO), CMUN = trimws(CMUN), cusec = paste0(CPRO, CMUN)) |> 
  distinct(cusec)


mun11 <- microdatos2011 |> 
  select(CPRO, CMUN) |> 
   mutate(
    CMUN = str_pad(CMUN, width = 3, side = "left", pad = "0"),
    CPRO = str_pad(CPRO, width = 2, side = "left", pad = "0")) |>
   mutate(CPRO = trimws(CPRO), CMUN = trimws(CMUN), cusec = paste0(CPRO, CMUN)) |> 
  distinct(cusec)

# These are the municipalities lost from 2021 to 2011. 
# Municipalities from 10000 to 20000 inhabitants
municipios994 <- mun21 |> 
  anti_join(mun11, by = "cusec") |> 
  mutate(cusec_994 = cusec)

mun_994 <- municipios994 |> 
  mutate(cusec = paste0(substr(cusec, 1, 2), "994")) 


# 2011
poblacion_mun11 <- read_xls("Población/pobmun11.xls")

poblacion_mun11 <- poblacion_mun11 |> 
  setNames(poblacion_mun11[1, ]) |> 
      slice(-1) |> 
    select(-c(MUJERES, VARONES)) |> 
  rename(Poblacion2011 = `AMBOS SEXOS`) |> 
    mutate(CPRO = trimws(CPRO), CMUN = trimws(CMUN), cusec = paste0(CPRO, CMUN)) 

cusec_rural_2011 <- poblacion_mun11 |> 
  mutate(Poblacion2011 = as.numeric(Poblacion2011)) |> 
  filter(Poblacion2011 < 20000) |> 
  mutate(cusec_original = cusec,
    cusec = case_when(
      Poblacion2011 < 2000 ~ paste0(substr(cusec_original, 1, 2), "991"),
      Poblacion2011 < 5000 ~ paste0(substr(cusec_original, 1, 2), "992"),
      Poblacion2011 < 10000 ~ paste0(substr(cusec_original, 1, 2), "993"),
      Poblacion2011 < 20000 ~ paste0(substr(cusec_original, 1, 2), "994"),
      TRUE ~ cusec
    )
  )

cusec_rural_2011 <- cusec_rural_2011 |> 
  distinct(cusec_original, .keep_all = TRUE) |> 
  select(cusec_original, cusec)


# 2021
poblacion_mun21 <- read_xlsx("Población/pobmun21.xlsx")

poblacion_mun21 <- poblacion_mun21 |> 
  setNames(poblacion_mun21[1, ]) |> 
      slice(-1) |> 
    select(-c(MUJERES, HOMBRES)) |> 
  rename(Poblacion2021 = `POB21`) |> 
    mutate(CPRO = trimws(CPRO), CMUN = trimws(CMUN), cusec = paste0(CPRO, CMUN)) 

cusec_rural_2021 <- poblacion_mun21 |> 
  mutate(Poblacion2021 = as.numeric(Poblacion2021)) |> 
  filter(Poblacion2021 < 20000) |> 
  mutate(cusec_original = cusec,
    cusec = case_when(
      Poblacion2021 < 2000 ~ paste0(substr(cusec_original, 1, 2), "991"),
      Poblacion2021 < 5000 ~ paste0(substr(cusec_original, 1, 2), "992"),
      Poblacion2021 < 10000 ~ paste0(substr(cusec_original, 1, 2), "993"),
      Poblacion2021 < 20000 ~ paste0(substr(cusec_original, 1, 2), "994"),
      TRUE ~ cusec
    )
  )

cusec_rural_2021 <- cusec_rural_2021 |> 
  distinct(cusec_original, .keep_all = TRUE) |> 
  select(cusec_original, cusec)

```

Compra

```{r}

# Definir databases
# 2011
compra11 <- microdatos2011 |> 
  select(CPRO, CMUN, EDAD, ANAC, NORDEN, ANORES, ANOM, LTRABA, MUNTRABA, TENEN, CON_NORDEN, OPA_NORDEN, TIPOPER, ESTHOG, EDADPAD, EDADMAD) 

compra11 <- compra11 |> 
  filter(EDAD %in% c(18:35), # Jóvenes
         TIPOPER != "H", # Que no son hijos en el núcleo
         is.na(EDADPAD), # Que no conviven con el padre
         is.na(EDADMAD)) |> # Que no conviven con la madre 
    select(-EDADPAD, -EDADMAD) |> 
  filter(ESTHOG %in% c(01, 02, 05, 07, 08, 10, 11)) # No es un hogar con una persona sola de +65 años ni hijos de más de 25

compra11 <- compra11 |> 
  mutate(mayor = ifelse(ANORES - ANAC > 18, TRUE, FALSE)) |> 
  filter(mayor == TRUE) # Que era mayor de edad en la última mudanza
  
compra11 <- compra11 |> 
  filter(NORDEN %in% c(1, 2)) # Que es orden 1 o 2 en el núcleo

#Recodificar tenen viv
compra11 <- compra11 |>  
  mutate(
    TENEN_r = case_when(
      TENEN == 1 ~ "Propiedad por compra, pagada",
      TENEN == 2 ~ "Propiedad por compra, pagos pendientes",
      TENEN == 3 ~ "Propiedad por herencia o donación",
      TENEN == 4 ~ "Alquiler",
      TENEN == 5 ~ "Cedida o a bajo precio",
      TENEN == 6 ~ "Otro")) |> 
  mutate(
    TENEN_VIV = case_when(
      TENEN_r %in% c("Propiedad por compra, pagada", "Propiedad por compra, pagos pendientes") ~ "Compra",
      TENEN_r == "Propiedad por herencia o donación" ~ "Herencia o donación",
      TENEN_r == "Alquiler" ~ "Alquiler",
      TENEN_r %in% c("Cedida o a bajo precio", "Otro") ~ "Otro"))

# Poner cusec
compra11 <- compra11 |>  
  mutate(
    CMUN = str_pad(CMUN, width = 3, side = "left", pad = "0"),
    CPRO = str_pad(CPRO, width = 2, side = "left", pad = "0")) |> 
   mutate(  
    CPRO = trimws(CPRO),
    CMUN = trimws(CMUN),
    cusec = paste0(CPRO, CMUN))


# 2021
compra21 <- microdatos2021 |> 
  select(CPRO, CMUN, VAREDAD, ANAC, TENEN_VIV, NORDEN, RESI_NACIM, VARANORES, VARANOM, CMUN_ANT, CMUN_UNANO, RESI_UNANO, CMUN_DANO, RESI_DANO, LTRAB, CMUN_TRAB, LEST, CMUN_EST, NORDEN_CON, NORDEN_OPA, TIPOPER, SEXO_MAD, SEXO_PAD, ESTRUC_HOG) 

compra21 <- compra21 |> 
  filter(VAREDAD %in% c(18:35), # Jóvenes
         TIPOPER != "H", # Que no son hijos en el núcleo
         SEXO_PAD == "N", # Que no conviven con el padre
         SEXO_MAD == "N") |>  # Que no conviven con la madre
  mutate(ESTRUC_HOG = as.numeric(ESTRUC_HOG)) |> 
  filter(ESTRUC_HOG %in% c(01, 02, 05, 07, 08, 10, 11)) # No es un hogar con una persona sola de +65 años ni hijos de más de 25

# Filtrar para haberse mudado a otra vivienda con mínimo 18 años, en una forma amplia

compra21 <- compra21 |> 
  mutate(
    VARANORES_r = case_when(
      VARANORES == "0005" ~ as.numeric(2015),
      VARANORES == "0004" ~ as.numeric(2010),
      VARANORES %in% c("9999", "0003") ~ as.numeric(2000), 
      VARANORES == " " ~ NA,
      TRUE ~ as.numeric(VARANORES)),
      ANAC = as.numeric(ANAC),
      mayor = ifelse(VARANORES_r - ANAC > 18, TRUE, FALSE)) |> 
  filter(mayor == TRUE)

compra21 <- compra21 |> 
  filter(NORDEN %in% c("01", "02")) # Que es orden 1 o 2 en el núcleo

# Recodificar código de tenencia
compra21 <- compra21 |> 
    mutate(
    TENEN_VIV = case_when(
      TENEN_VIV == 2 ~ "Propiedad",
      TENEN_VIV == 3 ~ "Alquiler",
      TENEN_VIV == 4 ~ "Otro")) 

# Poner cusec
compra21 <- compra21 |> 
  mutate(CPRO = trimws(CPRO), CMUN = trimws(CMUN), cusec = paste0(CPRO, CMUN))

# Crear variables por año -----------------------------------
# 2011
# Por municipio

propiedad <- propiedad %>%
  mutate(CPRO = case_when(
    MUN_LITERAL == "Baena" ~ "14",
    MUN_LITERAL == "Barañain" ~ "31",
    cusec == "47994" ~ "47",
    MUN_LITERAL == "Calatayud" ~ "50",
    TRUE ~ CPRO))


compra11<-compra11 |> 
  left_join(ccaas, by = c("CPRO" = "CodigoProvincia")) 

compra11 <- compra11 |>
  group_by(cusec) |>
  mutate(
    Compra11Mun = round((sum(TENEN_VIV == "Compra") / n()) * 100, 2),
    Propiedad11Mun = round((sum(TENEN_VIV %in% c("Compra", "Herencia o donación")) / n()) * 100, 2),
    Herencia11Mun = round((sum(TENEN_VIV == "Herencia o donación") / n()) * 100, 2),
    Alquiler11Mun = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro11Mun = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2)
  ) |>
  ungroup()

compra11 <- compra11 |>
  group_by(CPRO) |>
  mutate(
    Compra11Prov = round((sum(TENEN_VIV == "Compra") / n()) * 100, 2),
    Propiedad11Prov = round((sum(TENEN_VIV %in% c("Compra", "Herencia o donación")) / n()) * 100, 2),
    Herencia11Prov = round((sum(TENEN_VIV == "Herencia o donación") / n()) * 100, 2),
    Alquiler11Prov = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro11Prov = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2)
  ) |> 
  ungroup()

compra11 <- compra11 |>
  group_by(CCAA) |>
  mutate(
     Compra11CCAA = round((sum(TENEN_VIV == "Compra") / n()) * 100, 2),
    Propiedad11CCAA = round((sum(TENEN_VIV %in% c("Compra", "Herencia o donación")) / n()) * 100, 2),
    Herencia11CCAA = round((sum(TENEN_VIV == "Herencia o donación") / n()) * 100, 2),
    Alquiler11CCAA = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
  Otro11CCAA = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2)) |>
  ungroup()

# 2021
# Por municipio
compra21<-compra21 |> 
  left_join(ccaas, by = c("CPRO" = "CodigoProvincia")) 

compra21 <- compra21 |> 
  group_by(cusec) |> 
  mutate(
    Propiedad21Mun = round((sum(TENEN_VIV == "Propiedad") / n()) * 100, 2),
    Alquiler21Mun = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro21Mun = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2)) |> 
  ungroup()

compra21 <- compra21 |>
  group_by(CPRO) |>
  mutate(
    Propiedad21Prov = round((sum(TENEN_VIV == "Propiedad") / n()) * 100, 2),
    Alquiler21Prov = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro21Prov = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2)
  ) |> 
  ungroup() 

compra21 <- compra21 |>
  group_by(CCAA) |>
  mutate(
    Propiedad21CCAA = round((sum(TENEN_VIV == "Propiedad") / n()) * 100, 2),
    Alquiler21CCAA = round((sum(TENEN_VIV == "Alquiler") / n()) * 100, 2),
    Otro21CCAA = round((sum(TENEN_VIV == "Otro") / n()) * 100, 2)
  ) |> 
  ungroup() 


# Juntar pequeños municipios
compra21 <- compra21 |> 
  left_join(cusec_rural_2021, by = c("cusec" = "cusec_original")) |> 
  mutate(cusec = coalesce(cusec.y, cusec)) |> 
  select(-cusec.y) |> 
  group_by(cusec) |> # Group all small mun together by province 
  mutate(Propiedad21Mun = round(mean(Propiedad21Mun), 2),
            Alquiler21Mun = round(mean(Alquiler21Mun), 2),
            Otro21Mun = round(mean(Otro21Mun), 2)) |> 
  ungroup() 


# Crear diferencia -------------------------

tenencia11 <- compra11 |> 
  select(cusec, CPRO, Compra11Mun, Propiedad11Mun, Herencia11Mun, Alquiler11Mun, Otro11Mun, Propiedad11Prov, Herencia11Prov, Alquiler11Prov, Otro11Prov, Propiedad11CCAA, Herencia11CCAA, Alquiler11CCAA, Otro11CCAA) |> 
  distinct(cusec, .keep_all = T)

tenencia21 <- compra21 |> 
  select(cusec, CPRO, Propiedad21Mun, Alquiler21Mun, Otro21Mun, Propiedad21Prov, Alquiler21Prov, Otro21Prov, Propiedad21CCAA, Alquiler21CCAA, Otro21CCAA) |> 
  distinct(cusec, .keep_all = T)

tenencias <- tenencia11 |> 
  left_join(tenencia21, by = "cusec")

# Propiedad
tenencias <- tenencias |> 
  mutate(
    PropiedadDifMun = Propiedad21Mun - Propiedad11Mun,
    AlquilerDifMun = Alquiler21Mun - Alquiler11Mun,
    OtroDifMun = Otro21Mun - Otro11Mun,
    PropiedadDifProv = Propiedad21Prov - Propiedad11Prov,
    AlquilerDifProv = Alquiler21Prov - Alquiler11Prov,
    OtroDifProv = Otro21Prov - Otro11Prov,
    PropiedadDifCCAA = Propiedad21CCAA - Propiedad11CCAA,
    AlquilerDifCCAA = Alquiler21CCAA - Alquiler11CCAA,
    OtroDifCCAA = Otro21CCAA - Otro11CCAA)

propiedad <- propiedad |> 
  left_join(tenencias, by = "cusec") |> 
  distinct(cusec, .keep_all=T) |> 
  select(-CPRO.y) |> 
  mutate(CPRO=CPRO.x)

library(openxlsx)
write.xlsx(propiedad, "propiedad.xlsx")

```

## Analisis por municipios

Qué es realmente compra? qué método es más fiable?

Para saber si mis resultados son realmente fiables y me muestran los municipios donde ha aumentado la compra examino mis resultados a partir de distintos métodos para medir el cambio en la compra entre 2011 y 2021. Esto es porque tengo dudas de la precisión de los resultados debido a las interferencias de la herencia desconocida en 2021.

### Compra - propiedad

Creo que este método es el menos fiable o preciso porque siempre me va a sobredimensionar la propiedad en municipios donde hay herencia. Por ejemplo el caso de Ourense \<=2000. Si resto propiedad 2021 - compra 2011, éste me sale en el top 7 y con un supuesto aumento de la propiedad/compra del 18%.

Sin embargo, con todo propiedad está en el lugar 38 y el aumento es de solo un 1.44%. Además, en 2011 es el quinto municipio con más herencia de nuestra población objetivo (18% del total).

| 2011         | 2021          |
|--------------|---------------|
| Alquiler 20% | Alquiler 14%  |
| Compra 41%   | Propiedad 60% |
| Herencia 18% | \-            |
| Otro 20%     | Otro 24%      |

Se ha reducido un poco el alquiler, pero tampoco podemos ver que ese 6% que se ha perdido sea para la compra, porque también vemos un aumento del 4% de Otro. Lo que vemos claramente es que en 2011 existía un 59% de propiedad, y en 2021 un 60%. Con lo cual, el supuesto aumento de un 18% en compra realmente es la parte que ya existía de herencia y quizá un ligero aumento real de la compra.

```{r}
p<-propiedad11 %>%
  filter(cusec == "32991") %>%
  select(TENEN_VIV) |>
  table()

prop.table(p) * 100

p <- compra21 %>%
  filter(cusec == "32991") %>%
  select(TENEN_VIV) %>%
  table()

prop.table(p) * 100

```

### Propiedad - propiedad

Por ejemplo, el caso de Maó. Este municipio es el top 7 en aumento de propiedad (toda la propiedad) con cerca de un 10% de aumento. Con propiedad - compra, sale el 24. En 2011 aparece como el 4º municipio con menos compra, con sólo 34% y el quinto con más alquiler.

| 2011         | 2021          |
|--------------|---------------|
| Alquiler 50% | Alquiler 42%  |
| Compra 33%   | Propiedad 45% |
| Herencia 2%  | \-            |
| Otro 15%     | Otro 13%      |

En este caso, un municipio que en 2011 tenía muy poca herencia y ha visto reducido el alquiler, es claro que el aumento en propiedad se debe mayoritariamente a la compra y un aumento de ésta; si bien no podamos estimar exactamente en qué medida por desconocer la herencia del 2021.

Jaén 2000.

| 2011        | 2021          |
|-------------|---------------|
| Alquiler 9% | Alquiler 8%   |
| Compra 56%  | Propiedad 80% |
| Herencia 9% | \-            |
| Otro 24%    | Otro 12%      |

Lugo 2000

| 2011         | 2021          |
|--------------|---------------|
| Alquiler 19% | Alquiler 8%   |
| Compra 44%   | Propiedad 64% |
| Herencia 11% | \-            |
| Otro 26%     | Otro 26%      |

Úbeda

| 2011         | 2021          |
|--------------|---------------|
| Alquiler 20% | Alquiler 9%   |
| Compra 61%   | Propiedad 79% |
| Herencia 5%  | \-            |
| Otro 14%     | Otro 10%      |

Nerja

| 2011         | 2021          |
|--------------|---------------|
| Alquiler 39% | Alquiler 12%  |
| Compra 47%   | Propiedad 75% |
| Herencia 3%  | \-            |
| Otro 11%     | Otro 12%      |

Burjassot

| 2011         | 2021          |
|--------------|---------------|
| Alquiler 11% | Alquiler 37%  |
| Compra 82%   | Propiedad 42% |
| Herencia 3%  | \-            |
| Otro 4%      | Otro 19%      |

```{r}
p<-propiedad11 %>%
  filter(cusec == "07032") %>%
  select(TENEN_VIV) |>
  table()

prop.table(p) * 100

p <- compra21 %>%
  filter(cusec == "07032") %>%
  select(TENEN_VIV) %>%
  table()

prop.table(p) * 100

#Jaén 2000
p<-propiedad11 %>%
  filter(cusec == "23991") %>%
  select(TENEN_VIV) |>
  table()

prop.table(p) * 100

p <- compra21 %>%
  filter(cusec == "23991") %>%
  select(TENEN_VIV) %>%
  table()

prop.table(p) * 100


# General
table(propiedad11$TENEN_VIV)

# Nerja
p<- propiedad11 %>%
  filter(cusec == 29075) %>%
  select(TENEN_VIV) %>%
  table()

p <-compra21 %>%
  filter(cusec == 29075) %>%
  select(TENEN_VIV) %>%
  table()

prop.table(p) * 100


# Lugo 2000
p<- propiedad11 %>%
  filter(cusec == 27991) %>%
  select(TENEN_VIV) |>
  table()

prop.table(p) * 100


p <- compra21 %>%
  filter(cusec == 27991) %>%
  select(TENEN_VIV) %>%
  table()

# Jaén 2000
propiedad11 %>%
  filter(cusec == 23991) %>%
  select(TENEN_VIV) |>
  table()

compra21 %>%
  filter(cusec == 23991) %>%
  select(TENEN_VIV) %>%
  table()

# Ronda
propiedad11 %>%
  filter(cusec == 29084) %>%
  select(TENEN_VIV) |>
  table()

compra21 %>%
  filter(cusec == 29084) %>%
  select(TENEN_VIV) %>%
  table()

# Vícar
propiedad11 %>%
  filter(cusec == "04102") %>%
  select(TENEN_VIV) |>
  table()

compra21 %>%
  filter(cusec == "04102") %>%
  select(TENEN_VIV) %>%
  table()

# Maó
propiedad11 %>%
  filter(cusec == "07032") %>%
  select(TENEN_VIV) |>
  table()
compra21 %>%
  filter(cusec == "07032") %>%
  select(TENEN_VIV) %>%
  table()

# Huesca 2k-5k
propiedad11 %>%
  filter(cusec == 22992) %>%
  select(TENEN_VIV) |>
  table()
compra21 %>%
  filter(cusec == 22992) %>%
  select(TENEN_VIV) %>%
  table()

# Úbeda, top 2 ganancia de propiedad en Jaén menos 2k
p<-propiedad11 %>%
  filter(cusec == 23092) %>%
  select(TENEN_VIV) |>
  table()
  
p<-compra21 %>%
  filter(cusec == 23092) %>%
  select(TENEN_VIV) %>%
  table()

prop.table(p) * 100

# Nerja
propiedad11 %>%
  filter(cusec == 29075) %>%
  select(TENEN_VIV) %>%
  table()

compra21 %>%
  filter(cusec == 29075) %>%
  select(TENEN_VIV) %>%
  table()

# Burjassot

p<-propiedad11 %>%
  filter(cusec == 46078) %>%
  select(TENEN_VIV) |>
  table()
  
p<-compra21 %>%
  filter(cusec == 46078) %>%
  select(TENEN_VIV) %>%
  table()

prop.table(p) * 100


```

### Reducción alquiler

Lo de reducir alquiler

Calp.

| 2011         | 2021          |
|--------------|---------------|
| Alquiler 38% | Alquiler 27%  |
| Compra 52%   | Propiedad 57% |
| Herencia 4%  | \-            |
| Otro 5%      | Otro 13%      |

En este caso, un municipio que en 2011 tenía bastante alquiler, ha visto cómo este se reduce pero manteniendo una propiedad igual. Lo que ha aumentado es 'Otro'.

```{r}
p<-propiedad11 %>%
  filter(cusec == "03047") %>%
  select(TENEN_VIV) |>
  table()

prop.table(p) * 100

p <- compra21 %>%
  filter(cusec == "03047") %>%
  select(TENEN_VIV) %>%
  table()

prop.table(p) * 100


```

### Nerja

El caso de Nerja: municipio donde más ha aumentado la compra en ambos casos, y más reducción de alquiler

| 2011         | 2021          |
|--------------|---------------|
| Alquiler 38% | Alquiler 12%  |
| Compra 46%   | Propiedad 75% |
| Herencia 3%  | \-            |
| Otro 11%     | Otro 12%      |

```{r}
# Nerja
propiedad11 %>%
  filter(cusec == 29075) %>%
  select(TENEN_VIV) %>%
  table()

compra21 %>%
  filter(cusec == 29075) %>%
  select(TENEN_VIV) %>%
  table()


prop.table(p) * 100

```

Con lo cual, no voy a sacar resultados exactos de cuánto ha aumentado la compra en cada municipio por la interferencia de la herencia. Pero sí voy a poder ver tendencias y similiritudes entre los municipios donde ha aumentado la compra, aunque no sepa exactamente el porcentaje que ha aumentado. Considero que este es mi objetivo al fin y al cabo: discernir en qué tipo de municipio ha aumentado la compra, que es un perfil muy distinto al de municipios donde ha aumentado muchísimo el alquiler.
